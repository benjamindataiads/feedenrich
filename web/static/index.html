<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FeedEnrich - AI Product Enrichment</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        .diff-add { background-color: #d4edda; color: #155724; }
        .diff-remove { background-color: #f8d7da; color: #721c24; text-decoration: line-through; }
        .pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .slide-in { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .glow { box-shadow: 0 0 20px rgba(59, 130, 246, 0.5); }
        .typing::after { content: '|'; animation: blink 1s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        .log-scroll { scroll-behavior: smooth; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen" x-data="app()">
    
    <!-- Main Layout with Right Panel -->
    <div class="flex h-screen">
        <!-- Left: Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden" :class="showLogPanel ? 'mr-96' : ''">
            
            <!-- Header -->
            <header class="bg-gray-800 border-b border-gray-700 px-6 py-4 flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
                        üöÄ FeedEnrich
                    </h1>
                    <span class="text-sm text-gray-400">AI-Powered Product Enrichment</span>
                </div>
                <div class="flex items-center gap-4">
                    <button @click="showLogPanel = !showLogPanel" 
                            class="px-4 py-2 rounded-lg text-sm font-medium transition-all"
                            :class="showLogPanel ? 'bg-blue-600 text-white' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'">
                        <span x-show="!showLogPanel">üìä Show Agent Logs</span>
                        <span x-show="showLogPanel">üìä Hide Logs</span>
                    </button>
                </div>
            </header>

            <!-- Main Content Area -->
            <main class="flex-1 overflow-y-auto p-6 space-y-6">
                
                <!-- Upload Section -->
                <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                    <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <span>üìÅ</span> Import Dataset
                    </h2>
                    <form @submit.prevent="uploadDataset" class="flex gap-4 items-end flex-wrap">
                        <div class="flex-1 min-w-48">
                            <label class="block text-sm text-gray-400 mb-1">Dataset Name</label>
                            <input type="text" x-model="uploadName" placeholder="My Catalog Q1 2024" 
                                   class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-blue-500">
                        </div>
                        <div class="flex-1 min-w-48">
                            <label class="block text-sm text-gray-400 mb-1">TSV/CSV File</label>
                            <input type="file" @change="uploadFile = $event.target.files[0]" accept=".tsv,.csv,.txt"
                                   class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white file:mr-4 file:py-1 file:px-4 file:rounded file:border-0 file:bg-blue-600 file:text-white file:cursor-pointer">
                        </div>
                        <button type="submit" :disabled="!uploadFile || uploading" 
                                class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-50 font-medium">
                            <span x-show="!uploading">Upload</span>
                            <span x-show="uploading" class="pulse">Uploading...</span>
                        </button>
                    </form>
                </div>

                <!-- Datasets List -->
                <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold flex items-center gap-2">
                            <span>üìä</span> Datasets
                        </h2>
                        <button @click="loadDatasets" class="text-blue-400 text-sm hover:text-blue-300">‚Üª Refresh</button>
                    </div>
                    
                    <!-- Dataset Cards -->
                    <div class="space-y-4">
                        <template x-for="ds in datasets" :key="ds.id">
                            <div class="bg-gray-700/30 rounded-lg p-4 border border-gray-600 hover:border-gray-500 transition-colors">
                                <div class="flex justify-between items-start mb-3">
                                    <div>
                                        <h3 class="font-semibold text-white text-lg" x-text="ds.name"></h3>
                                        <p class="text-sm text-gray-400">
                                            <span x-text="ds.row_count"></span> products ‚Ä¢ 
                                            <span x-text="new Date(ds.created_at).toLocaleDateString()"></span>
                                        </p>
                                    </div>
                                    <div class="flex gap-2">
                                        <button @click="viewDataset(ds.id)" class="bg-blue-600 text-white px-3 py-1.5 rounded text-sm hover:bg-blue-700">View</button>
                                        <button @click="enrichAllProducts(ds.id)" 
                                                :disabled="globalEnriching"
                                                class="bg-green-600 text-white px-3 py-1.5 rounded text-sm hover:bg-green-700 disabled:opacity-50">
                                            ü§ñ Enrich All
                                        </button>
                                        <button @click="deleteDataset(ds.id)" class="bg-red-600/20 text-red-400 px-3 py-1.5 rounded text-sm hover:bg-red-600/40">Delete</button>
                                    </div>
                                </div>
                                
                                <!-- Quality Scores -->
                                <div class="grid grid-cols-2 gap-4 mt-4" x-show="datasetStats[ds.id]">
                                    <!-- Before Score -->
                                    <div class="bg-red-500/10 rounded-lg p-3 border border-red-500/30">
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="text-sm text-red-400 font-medium">üì¶ Before Quality</span>
                                            <span class="text-xl font-bold text-red-400" x-text="((datasetStats[ds.id]?.scores?.before || 0.35) * 100).toFixed(0) + '%'"></span>
                                        </div>
                                        <div class="w-full bg-gray-700 rounded-full h-2">
                                            <div class="bg-red-500 h-2 rounded-full transition-all duration-500"
                                                 :style="'width: ' + ((datasetStats[ds.id]?.scores?.before || 0.35) * 100) + '%'"></div>
                                        </div>
                                    </div>
                                    
                                    <!-- After Score -->
                                    <div class="bg-green-500/10 rounded-lg p-3 border border-green-500/30">
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="text-sm text-green-400 font-medium">‚ú® After Quality</span>
                                            <span class="text-xl font-bold text-green-400" x-text="((datasetStats[ds.id]?.scores?.after || 0.35) * 100).toFixed(0) + '%'"></span>
                                        </div>
                                        <div class="w-full bg-gray-700 rounded-full h-2">
                                            <div class="bg-green-500 h-2 rounded-full transition-all duration-500"
                                                 :style="'width: ' + ((datasetStats[ds.id]?.scores?.after || 0.35) * 100) + '%'"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Stats Row -->
                                <div class="flex gap-4 mt-3 text-sm" x-show="datasetStats[ds.id]">
                                    <div class="flex items-center gap-1 text-gray-400">
                                        <span class="text-blue-400 font-medium" x-text="datasetStats[ds.id]?.products?.enriched || 0"></span>
                                        <span>enriched</span>
                                    </div>
                                    <div class="flex items-center gap-1 text-gray-400">
                                        <span class="text-yellow-400 font-medium" x-text="datasetStats[ds.id]?.products?.pending || 0"></span>
                                        <span>pending</span>
                                    </div>
                                    <div class="flex items-center gap-1 text-gray-400">
                                        <span class="text-purple-400 font-medium" x-text="datasetStats[ds.id]?.proposals?.total || 0"></span>
                                        <span>proposals</span>
                                    </div>
                                    <div class="flex items-center gap-1 text-gray-400" x-show="datasetStats[ds.id]?.scores?.after > datasetStats[ds.id]?.scores?.before">
                                        <span class="text-green-400 font-medium">‚Üë +<span x-text="(((datasetStats[ds.id]?.scores?.after || 0) - (datasetStats[ds.id]?.scores?.before || 0)) * 100).toFixed(0)"></span>%</span>
                                        <span>improvement</span>
                                    </div>
                                </div>
                            </div>
                        </template>
                        <div x-show="datasets.length === 0" class="text-center text-gray-500 py-8">
                            No datasets yet. Upload one above!
                        </div>
                    </div>
                </div>

                <!-- Products (when dataset selected) -->
                <div x-show="selectedDataset" class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold flex items-center gap-2">
                            <span>üì¶</span> Products
                            <span class="text-sm text-gray-400" x-text="'(' + products.length + ' total)'"></span>
                        </h2>
                        <div class="flex gap-2">
                            <button @click="enrichAllProducts(selectedDataset)" 
                                    :disabled="globalEnriching"
                                    class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-700 disabled:opacity-50 flex items-center gap-2">
                                <span x-show="!globalEnriching">ü§ñ Enrich All Products</span>
                                <span x-show="globalEnriching" class="pulse">‚è≥ Enriching...</span>
                            </button>
                            <button @click="selectedDataset = null; products = []" class="text-gray-400 text-sm hover:text-gray-300">‚úï Close</button>
                        </div>
                    </div>
                    
                    <!-- Progress bar for global enrichment -->
                    <div x-show="globalEnriching" class="mb-4 bg-gray-700 rounded-full h-2 overflow-hidden">
                        <div class="bg-gradient-to-r from-blue-500 to-purple-500 h-full transition-all duration-500"
                             :style="'width: ' + enrichProgress + '%'"></div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="border-b border-gray-700">
                                <tr>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-400">ID</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-400">Title</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-400">Status</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-400">Score</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-400">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="p in products.slice(0, 50)" :key="p.id">
                                    <tr class="border-b border-gray-700/50 hover:bg-gray-700/30 transition-colors"
                                        :class="currentEnrichingProduct === p.id ? 'bg-blue-900/20 glow' : ''">
                                        <td class="px-4 py-3 font-mono text-sm text-gray-300" x-text="p.external_id"></td>
                                        <td class="px-4 py-3 max-w-xs truncate" x-text="getProductTitle(p)"></td>
                                        <td class="px-4 py-3">
                                            <span class="px-2 py-1 rounded text-xs font-medium"
                                                  :class="{
                                                    'bg-green-500/20 text-green-400': p.status === 'enriched',
                                                    'bg-blue-500/20 text-blue-400': currentEnrichingProduct === p.id,
                                                    'bg-gray-600/50 text-gray-400': p.status === 'pending' && currentEnrichingProduct !== p.id
                                                  }">
                                                <span x-show="currentEnrichingProduct === p.id" class="pulse">ü§ñ analyzing...</span>
                                                <span x-show="currentEnrichingProduct !== p.id" x-text="p.status"></span>
                                            </span>
                                        </td>
                                        <td class="px-4 py-3">
                                            <div x-show="p.agent_readiness_score" class="flex items-center gap-2">
                                                <div class="w-16 bg-gray-700 rounded-full h-2">
                                                    <div class="h-2 rounded-full transition-all"
                                                         :class="p.agent_readiness_score > 0.7 ? 'bg-green-500' : p.agent_readiness_score > 0.5 ? 'bg-yellow-500' : 'bg-red-500'"
                                                         :style="'width: ' + (p.agent_readiness_score * 100) + '%'"></div>
                                                </div>
                                                <span class="text-sm" x-text="(p.agent_readiness_score * 100).toFixed(0) + '%'"></span>
                                            </div>
                                            <span x-show="!p.agent_readiness_score" class="text-gray-500">-</span>
                                        </td>
                                        <td class="px-4 py-3 space-x-2">
                                            <button @click="enrichProduct(p)" 
                                                    :disabled="currentEnrichingProduct === p.id"
                                                    class="text-green-400 text-sm hover:text-green-300 disabled:opacity-50">ü§ñ Enrich</button>
                                            <button @click="viewProduct(p)" class="text-blue-400 text-sm hover:text-blue-300">View</button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                        <p x-show="products.length > 50" class="text-sm text-gray-500 mt-4 text-center">
                            Showing 50 of <span x-text="products.length"></span> products
                        </p>
                    </div>
                </div>

                <!-- Proposals Management -->
                <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold flex items-center gap-2">
                            <span>üìù</span> Recent Proposals
                            <span class="text-sm text-gray-400" x-text="'(' + filteredProposals.length + ' / ' + proposalsWithProducts.length + ')'"></span>
                        </h2>
                        <div class="flex gap-2">
                            <button @click="loadProposalsWithProducts" class="text-blue-400 text-sm hover:text-blue-300">‚Üª Refresh</button>
                        </div>
                    </div>

                    <!-- Filters & Auto-Accept Controls -->
                    <div class="bg-gray-700/30 rounded-lg p-4 mb-4 space-y-3">
                        <div class="flex flex-wrap gap-4">
                            <!-- Field Filter -->
                            <div class="flex-1 min-w-32">
                                <label class="text-xs text-gray-400 block mb-1">Field</label>
                                <select x-model="proposalFilters.field" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-1.5 text-sm">
                                    <option value="">All Fields</option>
                                    <option value="title">Title</option>
                                    <option value="titre">Titre</option>
                                    <option value="description">Description</option>
                                    <option value="color">Color</option>
                                    <option value="material">Material</option>
                                    <option value="gender">Gender</option>
                                </select>
                            </div>
                            
                            <!-- Min Confidence -->
                            <div class="flex-1 min-w-32">
                                <label class="text-xs text-gray-400 block mb-1">Min Confidence</label>
                                <select x-model="proposalFilters.minConfidence" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-1.5 text-sm">
                                    <option value="0">Any</option>
                                    <option value="0.5">‚â• 50%</option>
                                    <option value="0.7">‚â• 70%</option>
                                    <option value="0.8">‚â• 80%</option>
                                    <option value="0.9">‚â• 90%</option>
                                </select>
                            </div>
                            
                            <!-- Risk Level -->
                            <div class="flex-1 min-w-32">
                                <label class="text-xs text-gray-400 block mb-1">Risk Level</label>
                                <select x-model="proposalFilters.riskLevel" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-1.5 text-sm">
                                    <option value="">All</option>
                                    <option value="low">Low only</option>
                                    <option value="medium">Medium</option>
                                    <option value="high">High</option>
                                </select>
                            </div>

                            <!-- Status Filter -->
                            <div class="flex-1 min-w-32">
                                <label class="text-xs text-gray-400 block mb-1">Status</label>
                                <select x-model="proposalFilters.status" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-1.5 text-sm">
                                    <option value="">All</option>
                                    <option value="proposed">Pending</option>
                                    <option value="accepted">Accepted</option>
                                    <option value="rejected">Rejected</option>
                                </select>
                            </div>
                        </div>

                        <!-- Auto-Accept Actions -->
                        <div class="flex items-center justify-between pt-2 border-t border-gray-600">
                            <div class="text-sm text-gray-400">
                                <span x-text="filteredProposals.filter(p => p.status === 'proposed').length"></span> pending in current filter
                            </div>
                            <div class="flex gap-2">
                                <button @click="bulkAccept()" 
                                        :disabled="filteredProposals.filter(p => p.status === 'proposed').length === 0"
                                        class="bg-green-600 text-white px-4 py-1.5 rounded text-sm hover:bg-green-700 disabled:opacity-50 flex items-center gap-1">
                                    ‚úì Accept Filtered (<span x-text="filteredProposals.filter(p => p.status === 'proposed').length"></span>)
                                </button>
                                <button @click="bulkReject()" 
                                        :disabled="filteredProposals.filter(p => p.status === 'proposed').length === 0"
                                        class="bg-red-600/50 text-red-300 px-4 py-1.5 rounded text-sm hover:bg-red-600 disabled:opacity-50">
                                    ‚úó Reject Filtered
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Proposals List -->
                    <div x-show="proposalsWithProducts.length === 0" class="text-center text-gray-500 py-8">
                        No proposals yet. Enrich products to generate proposals.
                    </div>
                    <div x-show="proposalsWithProducts.length > 0" class="space-y-2 max-h-[500px] overflow-y-auto">
                        <template x-for="prop in filteredProposals.slice(0, 50)" :key="prop.id">
                            <div class="bg-gray-700/50 rounded-lg p-3 hover:bg-gray-700 transition-colors border-l-4"
                                 :class="{
                                    'border-green-500': prop.status === 'accepted',
                                    'border-red-500': prop.status === 'rejected',
                                    'border-yellow-500': prop.status === 'proposed'
                                 }">
                                <div class="flex justify-between items-start gap-4">
                                    <!-- Product & Field Info -->
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="text-xs text-gray-500 font-mono truncate max-w-32" x-text="prop.product_external_id || prop.product_id?.slice(0,8)"></span>
                                            <span class="text-xs text-gray-600">‚Ä¢</span>
                                            <span class="text-xs text-gray-400 truncate" x-text="prop.product_title?.slice(0,40) + (prop.product_title?.length > 40 ? '...' : '')"></span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span class="font-semibold text-white" x-text="prop.field"></span>
                                            <span class="text-xs px-1.5 py-0.5 rounded"
                                                  :class="{
                                                    'bg-green-500/20 text-green-400': prop.risk_level === 'low',
                                                    'bg-yellow-500/20 text-yellow-400': prop.risk_level === 'medium',
                                                    'bg-red-500/20 text-red-400': prop.risk_level === 'high'
                                                  }"
                                                  x-text="prop.risk_level"></span>
                                            <span class="text-xs px-1.5 py-0.5 rounded bg-blue-500/20 text-blue-400" x-text="(prop.confidence * 100).toFixed(0) + '%'"></span>
                                        </div>
                                    </div>
                                    
                                    <!-- Actions -->
                                    <div class="flex gap-1" x-show="prop.status === 'proposed'">
                                        <button @click="updateProposal(prop.id, 'accept')" class="text-xs bg-green-600 text-white px-2 py-1 rounded hover:bg-green-700">‚úì</button>
                                        <button @click="updateProposal(prop.id, 'reject')" class="text-xs bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700">‚úó</button>
                                    </div>
                                    <span x-show="prop.status !== 'proposed'" class="text-xs px-2 py-1 rounded whitespace-nowrap"
                                          :class="prop.status === 'accepted' ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'"
                                          x-text="prop.status"></span>
                                </div>
                                
                                <!-- Before/After -->
                                <div class="grid grid-cols-2 gap-2 mt-2 text-sm">
                                    <div class="diff-remove px-2 py-1 rounded text-xs truncate" x-text="prop.before_value || '(empty)'"></div>
                                    <div class="diff-add px-2 py-1 rounded text-xs truncate" x-text="prop.after_value"></div>
                                </div>
                            </div>
                        </template>
                        <p x-show="filteredProposals.length > 50" class="text-sm text-gray-500 text-center py-2">
                            Showing 50 of <span x-text="filteredProposals.length"></span> proposals
                        </p>
                    </div>
                </div>
            </main>
        </div>

        <!-- Right Panel: Agent Logs -->
        <div x-show="showLogPanel" 
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="translate-x-full"
             x-transition:enter-end="translate-x-0"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="translate-x-0"
             x-transition:leave-end="translate-x-full"
             class="fixed right-0 top-0 h-full w-96 bg-gray-800 border-l border-gray-700 flex flex-col shadow-2xl z-40">
            
            <!-- Panel Header -->
            <div class="p-4 border-b border-gray-700 bg-gradient-to-r from-blue-600 to-purple-600">
                <div class="flex justify-between items-center">
                    <h3 class="font-bold text-white flex items-center gap-2">
                        ü§ñ Agent Activity
                        <span x-show="globalEnriching || currentEnrichingProduct" class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
                    </h3>
                    <button @click="clearLogs" class="text-white/70 hover:text-white text-sm">Clear</button>
                </div>
                <p class="text-blue-100 text-sm mt-1">Real-time AI enrichment logs</p>
            </div>

            <!-- Stats Bar -->
            <div class="p-3 bg-gray-900/50 border-b border-gray-700 grid grid-cols-3 gap-2 text-center">
                <div>
                    <div class="text-2xl font-bold text-blue-400" x-text="agentStats.productsProcessed"></div>
                    <div class="text-xs text-gray-400">Processed</div>
                </div>
                <div>
                    <div class="text-2xl font-bold text-green-400" x-text="agentStats.proposalsGenerated"></div>
                    <div class="text-xs text-gray-400">Proposals</div>
                </div>
                <div>
                    <div class="text-2xl font-bold text-purple-400" x-text="agentStats.toolsUsed"></div>
                    <div class="text-xs text-gray-400">Tools Used</div>
                </div>
            </div>

            <!-- Logs Container -->
            <div class="flex-1 overflow-y-auto p-4 space-y-3 log-scroll" x-ref="logContainer">
                <template x-for="(log, index) in agentLogs" :key="index">
                    <div class="fade-in rounded-lg p-3 text-sm"
                         :class="{
                            'bg-blue-500/10 border border-blue-500/30': log.type === 'info',
                            'bg-green-500/10 border border-green-500/30': log.type === 'success',
                            'bg-yellow-500/10 border border-yellow-500/30': log.type === 'tool',
                            'bg-purple-500/10 border border-purple-500/30': log.type === 'thinking',
                            'bg-red-500/10 border border-red-500/30': log.type === 'error',
                            'bg-gray-700/50 border border-gray-600': log.type === 'step'
                         }">
                        <div class="flex items-start gap-2">
                            <span class="text-lg" x-text="getLogIcon(log.type)"></span>
                            <div class="flex-1 min-w-0">
                                <div class="font-medium text-white" x-text="log.title"></div>
                                <div class="text-gray-400 text-xs mt-1" x-text="log.message"></div>
                                <div x-show="log.details" class="mt-2 bg-gray-900/50 rounded p-2 text-xs font-mono text-gray-300 overflow-x-auto">
                                    <span x-text="log.details"></span>
                                </div>
                            </div>
                            <span class="text-xs text-gray-500 whitespace-nowrap" x-text="log.time"></span>
                        </div>
                    </div>
                </template>
                
                <!-- Empty state -->
                <div x-show="agentLogs.length === 0" class="text-center py-12 text-gray-500">
                    <div class="text-4xl mb-2">ü§ñ</div>
                    <p>No activity yet</p>
                    <p class="text-sm">Start enriching products to see agent logs</p>
                </div>
                
                <!-- Typing indicator -->
                <div x-show="isAgentThinking" class="flex items-center gap-2 text-blue-400 text-sm">
                    <span class="typing">Agent is thinking</span>
                </div>
            </div>

            <!-- Current Operation -->
            <div x-show="currentOperation" class="p-4 border-t border-gray-700 bg-gray-900/50">
                <div class="flex items-center gap-2 text-sm">
                    <span class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></span>
                    <span class="text-gray-300" x-text="currentOperation"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Detail Modal (3 columns) -->
    <div x-show="selectedProduct" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50">
        <div class="bg-gray-800 rounded-xl shadow-2xl w-[95vw] h-[95vh] overflow-hidden flex flex-col border border-gray-700">
            <!-- Header -->
            <div class="p-4 border-b border-gray-700 flex justify-between items-center bg-gradient-to-r from-blue-600 to-purple-600">
                <div>
                    <h3 class="font-bold text-xl text-white">Product Enrichment View</h3>
                    <p class="text-blue-100 text-sm">
                        <span x-text="selectedProduct?.external_id"></span> ‚Ä¢ 
                        <span x-text="getProductTitle(selectedProduct)"></span>
                    </p>
                </div>
                <div class="flex items-center gap-4">
                    <button @click="enrichProduct(selectedProduct)" 
                            :disabled="currentEnrichingProduct === selectedProduct?.id"
                            class="bg-white text-blue-600 px-4 py-2 rounded-lg font-medium hover:bg-blue-50 disabled:opacity-50">
                        <span x-show="currentEnrichingProduct !== selectedProduct?.id">ü§ñ Enrich</span>
                        <span x-show="currentEnrichingProduct === selectedProduct?.id" class="pulse">‚è≥ Enriching...</span>
                    </button>
                    <button @click="selectedProduct = null" class="text-white hover:text-blue-200 text-3xl">&times;</button>
                </div>
            </div>
            
            <!-- 3 Column Layout -->
            <div class="flex-1 overflow-hidden grid grid-cols-3 divide-x divide-gray-700">
                <!-- Column 1: Before -->
                <div class="flex flex-col overflow-hidden bg-red-900/10">
                    <div class="p-3 bg-red-500/20 border-b border-gray-700">
                        <h4 class="font-bold text-red-400">üì¶ BEFORE (Original)</h4>
                    </div>
                    <div class="flex-1 overflow-y-auto p-4 space-y-2">
                        <template x-for="[key, value] in getProductAttributes(selectedProduct?.raw_data)" :key="key">
                            <div class="bg-gray-800/50 rounded p-2">
                                <div class="text-xs font-medium text-gray-500 uppercase" x-text="key"></div>
                                <div class="text-sm mt-1 text-gray-300" x-text="value || '(empty)'"></div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Column 2: Analysis -->
                <div class="flex flex-col overflow-hidden bg-yellow-900/10">
                    <div class="p-3 bg-yellow-500/20 border-b border-gray-700">
                        <h4 class="font-bold text-yellow-400">üîç ANALYSIS & PROPOSALS</h4>
                    </div>
                    <div class="flex-1 overflow-y-auto p-4 space-y-3">
                        <div x-show="productProposals.length === 0" class="text-center py-8 text-gray-500">
                            <p class="text-4xl mb-2">ü§ñ</p>
                            <p>No proposals yet</p>
                        </div>
                        <template x-for="prop in productProposals" :key="prop.id">
                            <div class="bg-gray-800/50 rounded-lg p-3 border"
                                 :class="prop.status === 'accepted' ? 'border-green-500/50' : prop.status === 'rejected' ? 'border-red-500/50' : 'border-yellow-500/50'">
                                <div class="flex justify-between items-start mb-2">
                                    <span class="font-bold text-white" x-text="prop.field"></span>
                                    <span class="text-xs" x-text="(prop.confidence * 100).toFixed(0) + '%'"></span>
                                </div>
                                <div class="space-y-1 text-sm">
                                    <div class="diff-remove px-2 py-1 rounded" x-text="prop.before_value || '(empty)'"></div>
                                    <div class="diff-add px-2 py-1 rounded" x-text="prop.after_value"></div>
                                </div>
                                <div class="mt-2 flex gap-2" x-show="prop.status === 'proposed'">
                                    <button @click="updateProposal(prop.id, 'accept')" class="flex-1 text-xs bg-green-600 text-white py-1 rounded">‚úì Accept</button>
                                    <button @click="updateProposal(prop.id, 'reject')" class="flex-1 text-xs bg-red-600 text-white py-1 rounded">‚úó Reject</button>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Column 3: After -->
                <div class="flex flex-col overflow-hidden bg-green-900/10">
                    <div class="p-3 bg-green-500/20 border-b border-gray-700">
                        <h4 class="font-bold text-green-400">‚ú® AFTER (Optimized)</h4>
                    </div>
                    <div class="flex-1 overflow-y-auto p-4 space-y-2">
                        <template x-for="[key, value] in getOptimizedAttributes()" :key="key">
                            <div class="rounded p-2" :class="hasProposalForField(key) ? 'bg-green-500/20' : 'bg-gray-800/50'">
                                <div class="text-xs font-medium text-gray-500 uppercase flex justify-between">
                                    <span x-text="key"></span>
                                    <span x-show="hasProposalForField(key)" class="text-green-400">‚ú®</span>
                                </div>
                                <div class="text-sm mt-1 text-gray-300" x-text="value || '(empty)'"></div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="p-3 border-t border-gray-700 bg-gray-900/50 flex justify-between">
                <div class="text-sm text-gray-400">
                    <span x-text="productProposals.filter(p => p.status === 'accepted').length"></span> accepted,
                    <span x-text="productProposals.filter(p => p.status === 'proposed').length"></span> pending
                </div>
                <div class="flex gap-2">
                    <button @click="acceptAllProposals()" x-show="productProposals.some(p => p.status === 'proposed')"
                            class="bg-green-600 text-white px-4 py-2 rounded text-sm">Accept All</button>
                    <button @click="selectedProduct = null" class="bg-gray-700 text-white px-4 py-2 rounded text-sm">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function app() {
            return {
                // Data
                datasets: [],
                products: [],
                proposals: [],
                proposalsWithProducts: [],
                datasetStats: {},
                selectedDataset: null,
                selectedProduct: null,
                productProposals: [],
                uploadFile: null,
                uploadName: '',
                uploading: false,
                
                // Proposal filters
                proposalFilters: {
                    field: '',
                    minConfidence: '0',
                    riskLevel: '',
                    status: ''
                },
                
                // Agent state
                showLogPanel: true,
                agentLogs: [],
                agentStats: { productsProcessed: 0, proposalsGenerated: 0, toolsUsed: 0 },
                globalEnriching: false,
                currentEnrichingProduct: null,
                enrichProgress: 0,
                isAgentThinking: false,
                currentOperation: null,

                async init() {
                    await this.loadDatasets();
                    await this.loadProposalsWithProducts();
                    setInterval(() => this.loadProposalsWithProducts(), 5000);
                    setInterval(() => this.refreshAllDatasetStats(), 10000);
                },
                
                // Computed filtered proposals
                get filteredProposals() {
                    return this.proposalsWithProducts.filter(p => {
                        if (this.proposalFilters.field && p.field.toLowerCase() !== this.proposalFilters.field.toLowerCase()) {
                            return false;
                        }
                        if (this.proposalFilters.minConfidence && p.confidence < parseFloat(this.proposalFilters.minConfidence)) {
                            return false;
                        }
                        if (this.proposalFilters.riskLevel && p.risk_level !== this.proposalFilters.riskLevel) {
                            return false;
                        }
                        if (this.proposalFilters.status && p.status !== this.proposalFilters.status) {
                            return false;
                        }
                        return true;
                    });
                },

                async loadDatasetStats(datasetId) {
                    try {
                        const res = await fetch(`/api/datasets/${datasetId}/stats`);
                        const stats = await res.json();
                        this.datasetStats[datasetId] = stats;
                    } catch (e) {
                        console.error('Failed to load dataset stats:', e);
                    }
                },

                async refreshAllDatasetStats() {
                    for (const ds of this.datasets) {
                        await this.loadDatasetStats(ds.id);
                    }
                },

                // Logging
                addLog(type, title, message, details = null) {
                    const time = new Date().toLocaleTimeString();
                    this.agentLogs.unshift({ type, title, message, details, time });
                    if (this.agentLogs.length > 100) this.agentLogs.pop();
                    this.$nextTick(() => {
                        if (this.$refs.logContainer) {
                            this.$refs.logContainer.scrollTop = 0;
                        }
                    });
                },

                clearLogs() {
                    this.agentLogs = [];
                    this.agentStats = { productsProcessed: 0, proposalsGenerated: 0, toolsUsed: 0 };
                },

                getLogIcon(type) {
                    const icons = {
                        info: 'üìã', success: '‚úÖ', tool: 'üîß', thinking: 'üí≠', error: '‚ùå', step: '‚û°Ô∏è'
                    };
                    return icons[type] || 'üìå';
                },

                // Data loading
                async loadDatasets() {
                    const res = await fetch('/api/datasets');
                    const data = await res.json();
                    this.datasets = data.data || [];
                    // Load stats for each dataset
                    for (const ds of this.datasets) {
                        this.loadDatasetStats(ds.id);
                    }
                },

                async loadProposals() {
                    const res = await fetch('/api/proposals');
                    const data = await res.json();
                    const oldCount = this.proposals.length;
                    this.proposals = data.data || [];
                    
                    if (this.proposals.length > oldCount && oldCount > 0) {
                        this.agentStats.proposalsGenerated = this.proposals.length;
                    }
                    
                    if (this.selectedProduct) {
                        this.productProposals = this.proposals.filter(p => p.product_id === this.selectedProduct.id);
                    }
                },

                async loadProposalsWithProducts() {
                    try {
                        const res = await fetch('/api/proposals/with-products');
                        const data = await res.json();
                        const oldCount = this.proposalsWithProducts.length;
                        this.proposalsWithProducts = data.data || [];
                        this.proposals = this.proposalsWithProducts; // Keep backward compat
                        
                        if (this.proposalsWithProducts.length > oldCount && oldCount > 0) {
                            this.agentStats.proposalsGenerated = this.proposalsWithProducts.length;
                        }
                        
                        if (this.selectedProduct) {
                            this.productProposals = this.proposalsWithProducts.filter(p => p.product_id === this.selectedProduct.id);
                        }
                    } catch (e) {
                        console.error('Failed to load proposals:', e);
                        await this.loadProposals(); // Fallback
                    }
                },

                async bulkAccept() {
                    const pending = this.filteredProposals.filter(p => p.status === 'proposed');
                    if (pending.length === 0) return;
                    
                    const fields = this.proposalFilters.field ? [this.proposalFilters.field] : [];
                    const riskLevels = this.proposalFilters.riskLevel ? [this.proposalFilters.riskLevel] : [];
                    
                    this.addLog('info', 'Bulk accepting proposals', `${pending.length} proposals matching filters`);
                    
                    try {
                        const res = await fetch('/api/proposals/bulk', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                action: 'accept',
                                fields: fields,
                                min_confidence: parseFloat(this.proposalFilters.minConfidence) || 0,
                                risk_levels: riskLevels,
                                only_status: 'proposed'
                            })
                        });
                        
                        const data = await res.json();
                        this.addLog('success', 'Bulk accept complete', `${data.updated} proposals accepted`);
                        await this.loadProposalsWithProducts();
                    } catch (e) {
                        this.addLog('error', 'Bulk accept failed', e.message);
                    }
                },

                async bulkReject() {
                    const pending = this.filteredProposals.filter(p => p.status === 'proposed');
                    if (pending.length === 0) return;
                    
                    const fields = this.proposalFilters.field ? [this.proposalFilters.field] : [];
                    const riskLevels = this.proposalFilters.riskLevel ? [this.proposalFilters.riskLevel] : [];
                    
                    this.addLog('info', 'Bulk rejecting proposals', `${pending.length} proposals matching filters`);
                    
                    try {
                        const res = await fetch('/api/proposals/bulk', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                action: 'reject',
                                fields: fields,
                                min_confidence: parseFloat(this.proposalFilters.minConfidence) || 0,
                                risk_levels: riskLevels,
                                only_status: 'proposed'
                            })
                        });
                        
                        const data = await res.json();
                        this.addLog('success', 'Bulk reject complete', `${data.updated} proposals rejected`);
                        await this.loadProposalsWithProducts();
                    } catch (e) {
                        this.addLog('error', 'Bulk reject failed', e.message);
                    }
                },

                async uploadDataset() {
                    this.uploading = true;
                    this.addLog('info', 'Uploading dataset', `File: ${this.uploadFile.name}`);
                    
                    const formData = new FormData();
                    formData.append('file', this.uploadFile);
                    formData.append('name', this.uploadName || 'Untitled');

                    try {
                        const res = await fetch('/api/datasets/upload', { method: 'POST', body: formData });
                        if (res.ok) {
                            const ds = await res.json();
                            this.addLog('success', 'Dataset uploaded', `${ds.row_count} products imported`);
                            this.uploadFile = null;
                            this.uploadName = '';
                            await this.loadDatasets();
                        }
                    } finally {
                        this.uploading = false;
                    }
                },

                async viewDataset(id) {
                    this.selectedDataset = id;
                    const res = await fetch(`/api/datasets/${id}/products`);
                    const data = await res.json();
                    this.products = data.data || [];
                    this.addLog('info', 'Dataset loaded', `${this.products.length} products`);
                },

                async viewProduct(product) {
                    this.selectedProduct = product;
                    this.productProposals = this.proposals.filter(p => p.product_id === product.id);
                },

                // Enrichment
                async enrichProduct(product) {
                    this.currentEnrichingProduct = product.id;
                    this.isAgentThinking = true;
                    this.currentOperation = `Analyzing ${product.external_id}...`;
                    
                    this.addLog('thinking', 'Agent started', `Analyzing product: ${product.external_id}`);
                    this.addLog('tool', 'Tool: analyze_product', 'Evaluating current data quality and GMC compliance');
                    
                    try {
                        const res = await fetch(`/api/products/${product.id}/enrich`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ goal: 'GMC compliance + agent readiness' })
                        });

                        if (res.ok) {
                            this.agentStats.toolsUsed++;
                            this.addLog('info', 'Enrichment started', 'Agent is processing...');
                            
                            // Simulate tool usage logs
                            setTimeout(() => {
                                this.addLog('tool', 'Tool: web_search', 'Searching for product specifications');
                                this.agentStats.toolsUsed++;
                            }, 1000);
                            
                            setTimeout(() => {
                                this.addLog('tool', 'Tool: analyze_image', 'Extracting visual attributes from product image');
                                this.agentStats.toolsUsed++;
                            }, 2000);
                            
                            setTimeout(() => {
                                this.addLog('tool', 'Tool: optimize_field', 'Generating improved title and description');
                                this.agentStats.toolsUsed++;
                            }, 3000);

                            // Poll for completion
                            this.pollEnrichment(product.id);
                        }
                    } catch (e) {
                        this.addLog('error', 'Enrichment failed', e.message);
                        this.currentEnrichingProduct = null;
                        this.isAgentThinking = false;
                        this.currentOperation = null;
                    }
                },

                async pollEnrichment(productId) {
                    let attempts = 0;
                    const poll = async () => {
                        attempts++;
                        await this.loadProposals();
                        await this.refreshProducts();
                        
                        const hasProposals = this.proposals.some(p => p.product_id === productId);
                        const product = this.products.find(p => p.id === productId);
                        
                        if ((product?.status === 'enriched') || attempts >= 30) {
                            this.currentEnrichingProduct = null;
                            this.isAgentThinking = false;
                            this.currentOperation = null;
                            this.agentStats.productsProcessed++;
                            
                            const proposalCount = this.proposals.filter(p => p.product_id === productId).length;
                            this.agentStats.proposalsGenerated = this.proposals.length;
                            
                            if (product?.agent_readiness_score) {
                                this.addLog('success', 'Enrichment complete', 
                                    `Score: ${(product.agent_readiness_score * 100).toFixed(0)}% | ${proposalCount} proposals generated`,
                                    `Fields analyzed: title, description, color, material, gender`);
                            } else {
                                this.addLog('success', 'Enrichment complete', `${proposalCount} proposals generated`);
                            }
                            
                            if (this.selectedProduct?.id === productId) {
                                this.productProposals = this.proposals.filter(p => p.product_id === productId);
                            }
                        } else {
                            setTimeout(poll, 2000);
                        }
                    };
                    setTimeout(poll, 3000);
                },

                async refreshProducts() {
                    if (this.selectedDataset) {
                        const res = await fetch(`/api/datasets/${this.selectedDataset}/products`);
                        const data = await res.json();
                        this.products = data.data || [];
                    }
                },

                async enrichAllProducts(datasetId) {
                    if (!datasetId) return;
                    
                    this.globalEnriching = true;
                    this.enrichProgress = 0;
                    const startProposals = this.proposals.length;
                    
                    this.addLog('info', 'üöÄ Global enrichment started', `Processing all products in dataset`);
                    
                    // Load products if not loaded
                    if (!this.products.length || this.selectedDataset !== datasetId) {
                        await this.viewDataset(datasetId);
                    }
                    
                    const pendingProducts = this.products.filter(p => p.status !== 'enriched');
                    const total = pendingProducts.length;
                    
                    this.addLog('info', 'Products to process', `${total} products pending enrichment`);
                    
                    // Process ALL products (no limit)
                    for (let i = 0; i < total; i++) {
                        const product = pendingProducts[i];
                        this.currentEnrichingProduct = product.id;
                        this.currentOperation = `Processing ${i + 1}/${total}: ${product.external_id}`;
                        this.enrichProgress = ((i + 1) / total) * 100;
                        
                        this.addLog('step', `Product ${i + 1}/${total}`, product.external_id);
                        
                        await fetch(`/api/products/${product.id}/enrich`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ goal: 'GMC compliance + agent readiness' })
                        });
                        
                        this.agentStats.productsProcessed++;
                        this.agentStats.toolsUsed += 4;
                        
                        // Refresh proposals and stats periodically to show progress
                        if (i % 5 === 4) {
                            await this.loadProposals();
                            await this.loadDatasetStats(datasetId);
                            const newProposals = this.proposals.length - startProposals;
                            const stats = this.datasetStats[datasetId];
                            const scoreAfter = stats?.scores?.after || 0;
                            this.addLog('info', 'üìä Progress update', 
                                `${newProposals} new proposals | Quality: ${(scoreAfter * 100).toFixed(0)}%`);
                        }
                        
                        // Wait between products to avoid overwhelming the API
                        await new Promise(r => setTimeout(r, 2000));
                    }
                    
                    // Wait for last batch to complete
                    await new Promise(r => setTimeout(r, 5000));
                    await this.loadProposals();
                    await this.refreshProducts();
                    
                    const totalNewProposals = this.proposals.length - startProposals;
                    
                    this.globalEnriching = false;
                    this.currentEnrichingProduct = null;
                    this.currentOperation = null;
                    this.agentStats.proposalsGenerated = this.proposals.length;
                    
                    this.addLog('success', '‚úÖ Global enrichment complete', 
                        `Processed ${total} products, generated ${totalNewProposals} new proposals (${this.proposals.length} total)`);
                },

                async updateProposal(id, action) {
                    const res = await fetch(`/api/proposals/${id}`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action })
                    });
                    if (res.ok) {
                        this.addLog(action === 'accept' ? 'success' : 'info', 
                            `Proposal ${action}ed`, '');
                        await this.loadProposals();
                    }
                },

                async acceptAllProposals() {
                    const pending = this.productProposals.filter(p => p.status === 'proposed');
                    for (const prop of pending) {
                        await this.updateProposal(prop.id, 'accept');
                    }
                },

                async deleteDataset(id) {
                    if (!confirm('Delete this dataset?')) return;
                    await fetch(`/api/datasets/${id}`, { method: 'DELETE' });
                    this.addLog('info', 'Dataset deleted', '');
                    await this.loadDatasets();
                },

                // Helpers
                getProductTitle(p) {
                    if (!p) return '-';
                    const data = this.parseData(p.raw_data);
                    return data.title || data.Title || data.titre || data.Titre || data.name || '-';
                },

                parseData(data) {
                    if (!data) return {};
                    if (typeof data === 'string') {
                        try { return JSON.parse(data); } catch { return {}; }
                    }
                    return data;
                },

                getProductAttributes(data) {
                    const parsed = this.parseData(data);
                    const priority = ['titre', 'title', 'description', 'marque', 'brand', 'prix', 'price', 'couleur', 'color'];
                    return Object.entries(parsed).sort((a, b) => {
                        const aIdx = priority.indexOf(a[0].toLowerCase());
                        const bIdx = priority.indexOf(b[0].toLowerCase());
                        if (aIdx !== -1 && bIdx !== -1) return aIdx - bIdx;
                        if (aIdx !== -1) return -1;
                        if (bIdx !== -1) return 1;
                        return a[0].localeCompare(b[0]);
                    });
                },

                getOptimizedAttributes() {
                    const raw = this.parseData(this.selectedProduct?.raw_data);
                    const optimized = { ...raw };
                    for (const prop of this.productProposals) {
                        if (prop.status === 'accepted') {
                            optimized[prop.field] = prop.after_value;
                        }
                    }
                    return this.getProductAttributes(optimized);
                },

                hasProposalForField(field) {
                    return this.productProposals.some(p => 
                        p.field.toLowerCase() === field.toLowerCase() && p.status === 'accepted'
                    );
                },

                parseSources(sources) {
                    if (!sources) return [];
                    if (Array.isArray(sources)) return sources;
                    try { return JSON.parse(sources); } catch { return []; }
                }
            }
        }
    </script>
</body>
</html>
