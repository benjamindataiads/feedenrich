<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FeedEnrich - AI Product Enrichment</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        .diff-add { background-color: #d4edda; color: #155724; }
        .diff-remove { background-color: #f8d7da; color: #721c24; text-decoration: line-through; }
        .pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .slide-in { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .glow { box-shadow: 0 0 20px rgba(59, 130, 246, 0.5); }
        .typing::after { content: '|'; animation: blink 1s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        .log-scroll { scroll-behavior: smooth; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen" x-data="app()">
    
    <!-- Main Layout with Right Panel -->
    <div class="flex h-screen">
        <!-- Left: Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden" :class="showLogPanel ? 'mr-96' : ''">
            
            <!-- Header -->
            <header class="bg-gray-800 border-b border-gray-700 px-6 py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-4">
                        <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
                            üöÄ FeedEnrich
                        </h1>
                        <span class="text-sm text-gray-400">AI-Powered Product Enrichment</span>
                    </div>
                    <div class="flex items-center gap-4">
                        <button @click="showLogPanel = !showLogPanel" 
                                class="px-4 py-2 rounded-lg text-sm font-medium transition-all"
                                :class="showLogPanel ? 'bg-blue-600 text-white' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'">
                            <span x-show="!showLogPanel">üìä Show Agent Logs</span>
                            <span x-show="showLogPanel">üìä Hide Logs</span>
                        </button>
                    </div>
                </div>
                <!-- Navigation Tabs -->
                <div class="flex gap-1 mt-4">
                    <button @click="currentTab = 'dashboard'" 
                            class="px-4 py-2 rounded-t-lg text-sm font-medium transition-all"
                            :class="currentTab === 'dashboard' ? 'bg-gray-700 text-white' : 'text-gray-400 hover:text-white'">
                        üìä Dashboard
                    </button>
                    <button @click="currentTab = 'validation'" 
                            class="px-4 py-2 rounded-t-lg text-sm font-medium transition-all"
                            :class="currentTab === 'validation' ? 'bg-gray-700 text-white' : 'text-gray-400 hover:text-white'">
                        ‚úÖ Validation
                        <span x-show="pendingValidationCount > 0" class="ml-1 px-1.5 py-0.5 text-xs bg-orange-500 rounded-full" x-text="pendingValidationCount"></span>
                    </button>
                    <button @click="currentTab = 'settings'" 
                            class="px-4 py-2 rounded-t-lg text-sm font-medium transition-all"
                            :class="currentTab === 'settings' ? 'bg-gray-700 text-white' : 'text-gray-400 hover:text-white'">
                        ‚öôÔ∏è Agent Settings
                    </button>
                    <button @click="currentTab = 'docs'" 
                            class="px-4 py-2 rounded-t-lg text-sm font-medium transition-all"
                            :class="currentTab === 'docs' ? 'bg-gray-700 text-white' : 'text-gray-400 hover:text-white'">
                        üìñ Documentation
                    </button>
                </div>
            </header>

            <!-- Main Content Area -->
            <main class="flex-1 overflow-y-auto p-6 space-y-6">
                
                <!-- ============ DASHBOARD TAB ============ -->
                <div x-show="currentTab === 'dashboard'">
                
                <!-- Upload Section -->
                <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 mb-6">
                    <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <span>üìÅ</span> Import Dataset
                    </h2>
                    <form @submit.prevent="uploadDataset" class="flex gap-4 items-end flex-wrap">
                        <div class="flex-1 min-w-48">
                            <label class="block text-sm text-gray-400 mb-1">Dataset Name</label>
                            <input type="text" x-model="uploadName" placeholder="My Catalog Q1 2024" 
                                   class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-blue-500">
                        </div>
                        <div class="flex-1 min-w-48">
                            <label class="block text-sm text-gray-400 mb-1">TSV/CSV File</label>
                            <input type="file" @change="uploadFile = $event.target.files[0]" accept=".tsv,.csv,.txt"
                                   class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white file:mr-4 file:py-1 file:px-4 file:rounded file:border-0 file:bg-blue-600 file:text-white file:cursor-pointer">
                        </div>
                        <button type="submit" :disabled="!uploadFile || uploading" 
                                class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-50 font-medium">
                            <span x-show="!uploading">Upload</span>
                            <span x-show="uploading" class="pulse">Uploading...</span>
                        </button>
                    </form>
                </div>

                <!-- Datasets List -->
                <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold flex items-center gap-2">
                            <span>üìä</span> Datasets
                        </h2>
                        <button @click="loadDatasets" class="text-blue-400 text-sm hover:text-blue-300">‚Üª Refresh</button>
                    </div>
                    
                    <!-- Dataset Cards -->
                    <div class="space-y-4">
                        <template x-for="ds in datasets" :key="ds.id">
                            <div class="bg-gray-700/30 rounded-lg p-4 border border-gray-600 hover:border-gray-500 transition-colors">
                                <div class="flex justify-between items-start mb-3">
                                    <div>
                                        <h3 class="font-semibold text-white text-lg" x-text="ds.name"></h3>
                                        <p class="text-sm text-gray-400">
                                            <span x-text="ds.row_count"></span> products ‚Ä¢ 
                                            <span x-text="new Date(ds.created_at).toLocaleDateString()"></span>
                                        </p>
                                    </div>
                                    <div class="flex gap-2">
                                        <button @click="viewDataset(ds.id)" class="bg-blue-600 text-white px-3 py-1.5 rounded text-sm hover:bg-blue-700">View</button>
                                        <button @click="enrichAllProducts(ds.id)" 
                                                :disabled="globalEnriching"
                                                class="bg-green-600 text-white px-3 py-1.5 rounded text-sm hover:bg-green-700 disabled:opacity-50">
                                            ü§ñ Enrich All
                                        </button>
                                        <button @click="deleteDataset(ds.id)" class="bg-red-600/20 text-red-400 px-3 py-1.5 rounded text-sm hover:bg-red-600/40">Delete</button>
                                    </div>
                                </div>
                                
                                <!-- Quality Scores -->
                                <div class="grid grid-cols-2 gap-4 mt-4" x-show="datasetStats[ds.id]">
                                    <!-- Before Score -->
                                    <div class="bg-red-500/10 rounded-lg p-3 border border-red-500/30">
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="text-sm text-red-400 font-medium">üì¶ Before Quality</span>
                                            <span class="text-xl font-bold text-red-400" x-text="((datasetStats[ds.id]?.scores?.before || 0.35) * 100).toFixed(0) + '%'"></span>
                                        </div>
                                        <div class="w-full bg-gray-700 rounded-full h-2">
                                            <div class="bg-red-500 h-2 rounded-full transition-all duration-500"
                                                 :style="'width: ' + ((datasetStats[ds.id]?.scores?.before || 0.35) * 100) + '%'"></div>
                                        </div>
                                    </div>
                                    
                                    <!-- After Score -->
                                    <div class="bg-green-500/10 rounded-lg p-3 border border-green-500/30">
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="text-sm text-green-400 font-medium">‚ú® After Quality</span>
                                            <span class="text-xl font-bold text-green-400" x-text="((datasetStats[ds.id]?.scores?.after || 0.35) * 100).toFixed(0) + '%'"></span>
                                        </div>
                                        <div class="w-full bg-gray-700 rounded-full h-2">
                                            <div class="bg-green-500 h-2 rounded-full transition-all duration-500"
                                                 :style="'width: ' + ((datasetStats[ds.id]?.scores?.after || 0.35) * 100) + '%'"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Stats Row -->
                                <div class="flex gap-4 mt-3 text-sm" x-show="datasetStats[ds.id]">
                                    <div class="flex items-center gap-1 text-gray-400">
                                        <span class="text-blue-400 font-medium" x-text="datasetStats[ds.id]?.products?.enriched || 0"></span>
                                        <span>enriched</span>
                                    </div>
                                    <div class="flex items-center gap-1 text-gray-400">
                                        <span class="text-yellow-400 font-medium" x-text="datasetStats[ds.id]?.products?.pending || 0"></span>
                                        <span>pending</span>
                                    </div>
                                    <div class="flex items-center gap-1 text-gray-400">
                                        <span class="text-purple-400 font-medium" x-text="datasetStats[ds.id]?.proposals?.total || 0"></span>
                                        <span>proposals</span>
                                    </div>
                                    <div class="flex items-center gap-1 text-gray-400" x-show="datasetStats[ds.id]?.scores?.after > datasetStats[ds.id]?.scores?.before">
                                        <span class="text-green-400 font-medium">‚Üë +<span x-text="(((datasetStats[ds.id]?.scores?.after || 0) - (datasetStats[ds.id]?.scores?.before || 0)) * 100).toFixed(0)"></span>%</span>
                                        <span>improvement</span>
                                    </div>
                                </div>
                            </div>
                        </template>
                        <div x-show="datasets.length === 0" class="text-center text-gray-500 py-8">
                            No datasets yet. Upload one above!
                        </div>
                    </div>
                </div>

                <!-- Products (when dataset selected) -->
                <div x-show="selectedDataset" class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold flex items-center gap-2">
                            <span>üì¶</span> Products
                            <span class="text-sm text-gray-400" x-text="'(' + products.length + ' total)'"></span>
                        </h2>
                        <div class="flex gap-2">
                            <button @click="enrichAllProducts(selectedDataset)" 
                                    :disabled="globalEnriching"
                                    class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-700 disabled:opacity-50 flex items-center gap-2">
                                <span x-show="!globalEnriching">ü§ñ Enrich All Products</span>
                                <span x-show="globalEnriching" class="pulse">‚è≥ Enriching...</span>
                            </button>
                            <button @click="selectedDataset = null; products = []" class="text-gray-400 text-sm hover:text-gray-300">‚úï Close</button>
                        </div>
                    </div>
                    
                    <!-- Progress bar for global enrichment -->
                    <div x-show="globalEnriching" class="mb-4 bg-gray-700 rounded-full h-2 overflow-hidden">
                        <div class="bg-gradient-to-r from-blue-500 to-purple-500 h-full transition-all duration-500"
                             :style="'width: ' + enrichProgress + '%'"></div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="border-b border-gray-700">
                                <tr>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-400">ID</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-400">Title</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-400">Status</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-400">Score</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-400">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="p in products.slice(0, 50)" :key="p.id">
                                    <tr class="border-b border-gray-700/50 hover:bg-gray-700/30 transition-colors"
                                        :class="currentEnrichingProduct === p.id ? 'bg-blue-900/20 glow' : ''">
                                        <td class="px-4 py-3 font-mono text-sm text-gray-300" x-text="p.external_id"></td>
                                        <td class="px-4 py-3 max-w-xs truncate" x-text="getProductTitle(p)"></td>
                                        <td class="px-4 py-3">
                                            <span class="px-2 py-1 rounded text-xs font-medium"
                                                  :class="{
                                                    'bg-green-500/20 text-green-400': p.status === 'enriched',
                                                    'bg-blue-500/20 text-blue-400': currentEnrichingProduct === p.id,
                                                    'bg-gray-600/50 text-gray-400': p.status === 'pending' && currentEnrichingProduct !== p.id
                                                  }">
                                                <span x-show="currentEnrichingProduct === p.id" class="pulse">ü§ñ analyzing...</span>
                                                <span x-show="currentEnrichingProduct !== p.id" x-text="p.status"></span>
                                            </span>
                                        </td>
                                        <td class="px-4 py-3">
                                            <div x-show="p.agent_readiness_score" class="flex items-center gap-2">
                                                <div class="w-16 bg-gray-700 rounded-full h-2">
                                                    <div class="h-2 rounded-full transition-all"
                                                         :class="p.agent_readiness_score > 0.7 ? 'bg-green-500' : p.agent_readiness_score > 0.5 ? 'bg-yellow-500' : 'bg-red-500'"
                                                         :style="'width: ' + (p.agent_readiness_score * 100) + '%'"></div>
                                                </div>
                                                <span class="text-sm" x-text="(p.agent_readiness_score * 100).toFixed(0) + '%'"></span>
                                            </div>
                                            <span x-show="!p.agent_readiness_score" class="text-gray-500">-</span>
                                        </td>
                                        <td class="px-4 py-3 space-x-2">
                                            <button @click="enrichProduct(p)" 
                                                    :disabled="currentEnrichingProduct === p.id"
                                                    class="text-green-400 text-sm hover:text-green-300 disabled:opacity-50">ü§ñ Enrich</button>
                                            <button @click="viewProduct(p)" class="text-blue-400 text-sm hover:text-blue-300">View</button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                        <p x-show="products.length > 50" class="text-sm text-gray-500 mt-4 text-center">
                            Showing 50 of <span x-text="products.length"></span> products
                        </p>
                    </div>
                </div>

                <!-- Proposals Management -->
                <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold flex items-center gap-2">
                            <span>üìù</span> Recent Proposals
                            <span class="text-sm text-gray-400" x-text="'(' + filteredProposals.length + ' / ' + proposalsWithProducts.length + ')'"></span>
                        </h2>
                        <div class="flex gap-2">
                            <button @click="loadProposalsWithProducts" class="text-blue-400 text-sm hover:text-blue-300">‚Üª Refresh</button>
                        </div>
                    </div>

                    <!-- Filters & Auto-Accept Controls -->
                    <div class="bg-gray-700/30 rounded-lg p-4 mb-4 space-y-3">
                        <div class="flex flex-wrap gap-4">
                            <!-- Field Filter -->
                            <div class="flex-1 min-w-32">
                                <label class="text-xs text-gray-400 block mb-1">Field</label>
                                <select x-model="proposalFilters.field" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-1.5 text-sm">
                                    <option value="">All Fields</option>
                                    <option value="title">Title</option>
                                    <option value="titre">Titre</option>
                                    <option value="description">Description</option>
                                    <option value="color">Color</option>
                                    <option value="material">Material</option>
                                    <option value="gender">Gender</option>
                                </select>
                            </div>
                            
                            <!-- Min Confidence -->
                            <div class="flex-1 min-w-32">
                                <label class="text-xs text-gray-400 block mb-1">Min Confidence</label>
                                <select x-model="proposalFilters.minConfidence" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-1.5 text-sm">
                                    <option value="0">Any</option>
                                    <option value="0.5">‚â• 50%</option>
                                    <option value="0.7">‚â• 70%</option>
                                    <option value="0.8">‚â• 80%</option>
                                    <option value="0.9">‚â• 90%</option>
                                </select>
                            </div>
                            
                            <!-- Risk Level -->
                            <div class="flex-1 min-w-32">
                                <label class="text-xs text-gray-400 block mb-1">Risk Level</label>
                                <select x-model="proposalFilters.riskLevel" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-1.5 text-sm">
                                    <option value="">All</option>
                                    <option value="low">Low only</option>
                                    <option value="medium">Medium</option>
                                    <option value="high">High</option>
                                </select>
                            </div>

                            <!-- Status Filter -->
                            <div class="flex-1 min-w-32">
                                <label class="text-xs text-gray-400 block mb-1">Status</label>
                                <select x-model="proposalFilters.status" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-1.5 text-sm">
                                    <option value="">All</option>
                                    <option value="proposed">Pending</option>
                                    <option value="accepted">Accepted</option>
                                    <option value="rejected">Rejected</option>
                                </select>
                            </div>
                        </div>

                        <!-- Auto-Accept Actions -->
                        <div class="flex items-center justify-between pt-2 border-t border-gray-600">
                            <div class="text-sm text-gray-400">
                                <span x-text="filteredProposals.filter(p => p.status === 'proposed').length"></span> pending in current filter
                            </div>
                            <div class="flex gap-2">
                                <button @click="bulkAccept()" 
                                        :disabled="filteredProposals.filter(p => p.status === 'proposed').length === 0"
                                        class="bg-green-600 text-white px-4 py-1.5 rounded text-sm hover:bg-green-700 disabled:opacity-50 flex items-center gap-1">
                                    ‚úì Accept Filtered (<span x-text="filteredProposals.filter(p => p.status === 'proposed').length"></span>)
                                </button>
                                <button @click="bulkReject()" 
                                        :disabled="filteredProposals.filter(p => p.status === 'proposed').length === 0"
                                        class="bg-red-600/50 text-red-300 px-4 py-1.5 rounded text-sm hover:bg-red-600 disabled:opacity-50">
                                    ‚úó Reject Filtered
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Proposals List -->
                    <div x-show="proposalsWithProducts.length === 0" class="text-center text-gray-500 py-8">
                        No proposals yet. Enrich products to generate proposals.
                    </div>
                    <div x-show="proposalsWithProducts.length > 0" class="space-y-2 max-h-[500px] overflow-y-auto">
                        <template x-for="prop in filteredProposals.slice(0, 50)" :key="prop.id">
                            <div class="bg-gray-700/50 rounded-lg p-3 hover:bg-gray-700 transition-colors border-l-4"
                                 :class="{
                                    'border-green-500': prop.status === 'accepted',
                                    'border-red-500': prop.status === 'rejected',
                                    'border-yellow-500': prop.status === 'proposed'
                                 }">
                                <div class="flex justify-between items-start gap-4">
                                    <!-- Product & Field Info -->
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="text-xs text-gray-500 font-mono truncate max-w-32" x-text="prop.product_external_id || prop.product_id?.slice(0,8)"></span>
                                            <span class="text-xs text-gray-600">‚Ä¢</span>
                                            <span class="text-xs text-gray-400 truncate" x-text="prop.product_title?.slice(0,40) + (prop.product_title?.length > 40 ? '...' : '')"></span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span class="font-semibold text-white" x-text="prop.field"></span>
                                            <span class="text-xs px-1.5 py-0.5 rounded"
                                                  :class="{
                                                    'bg-green-500/20 text-green-400': prop.risk_level === 'low',
                                                    'bg-yellow-500/20 text-yellow-400': prop.risk_level === 'medium',
                                                    'bg-red-500/20 text-red-400': prop.risk_level === 'high'
                                                  }"
                                                  x-text="prop.risk_level"></span>
                                            <span class="text-xs px-1.5 py-0.5 rounded bg-blue-500/20 text-blue-400" x-text="(prop.confidence * 100).toFixed(0) + '%'"></span>
                                        </div>
                                    </div>
                                    
                                    <!-- Actions -->
                                    <div class="flex gap-1" x-show="prop.status === 'proposed'">
                                        <button @click="updateProposal(prop.id, 'accept')" class="text-xs bg-green-600 text-white px-2 py-1 rounded hover:bg-green-700">‚úì</button>
                                        <button @click="updateProposal(prop.id, 'reject')" class="text-xs bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700">‚úó</button>
                                    </div>
                                    <span x-show="prop.status !== 'proposed'" class="text-xs px-2 py-1 rounded whitespace-nowrap"
                                          :class="prop.status === 'accepted' ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'"
                                          x-text="prop.status"></span>
                                </div>
                                
                                <!-- Before/After -->
                                <div class="grid grid-cols-2 gap-2 mt-2 text-sm">
                                    <div class="diff-remove px-2 py-1 rounded text-xs truncate" x-text="prop.before_value || '(empty)'"></div>
                                    <div class="diff-add px-2 py-1 rounded text-xs truncate" x-text="prop.after_value"></div>
                                </div>
                            </div>
                        </template>
                        <p x-show="filteredProposals.length > 50" class="text-sm text-gray-500 text-center py-2">
                            Showing 50 of <span x-text="filteredProposals.length"></span> proposals
                        </p>
                    </div>
                </div>
                
                </div><!-- End Dashboard Tab -->

                <!-- ============ VALIDATION TAB ============ -->
                <div x-show="currentTab === 'validation'" x-init="initValidation()" class="space-y-6">
                    
                    <!-- Sampling Controls -->
                    <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h2 class="text-xl font-bold flex items-center gap-2">üéØ Validation par √âchantillonnage</h2>
                                <p class="text-gray-400 text-sm mt-1">Validez un √©chantillon al√©atoire pour estimer la qualit√© globale</p>
                            </div>
                            <div class="flex items-center gap-4">
                                <select x-model="validationDataset" @change="loadValidationSample()" 
                                        class="bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-sm">
                                    <option value="">S√©lectionner un dataset</option>
                                    <template x-for="ds in datasets" :key="ds.id">
                                        <option :value="ds.id" x-text="ds.name"></option>
                                    </template>
                                </select>
                                <button @click="loadValidationSample()" 
                                        :disabled="!validationDataset"
                                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 text-sm">
                                    üîÑ Nouvel √©chantillon
                                </button>
                            </div>
                        </div>

                        <!-- Statistical Confidence Panel -->
                        <div class="grid grid-cols-4 gap-4 mb-6">
                            <div class="bg-gray-700/50 rounded-lg p-4 text-center">
                                <div class="text-3xl font-bold text-blue-400" x-text="validationStats.reviewed"></div>
                                <div class="text-xs text-gray-400 mt-1">Produits valid√©s</div>
                            </div>
                            <div class="bg-gray-700/50 rounded-lg p-4 text-center">
                                <div class="text-3xl font-bold" 
                                     :class="validationStats.approvalRate >= 0.8 ? 'text-green-400' : validationStats.approvalRate >= 0.6 ? 'text-yellow-400' : 'text-red-400'"
                                     x-text="(validationStats.approvalRate * 100).toFixed(0) + '%'"></div>
                                <div class="text-xs text-gray-400 mt-1">Taux d'approbation</div>
                            </div>
                            <div class="bg-gray-700/50 rounded-lg p-4 text-center">
                                <div class="text-3xl font-bold text-purple-400" x-text="validationStats.confidence + '%'"></div>
                                <div class="text-xs text-gray-400 mt-1">Niveau de confiance</div>
                            </div>
                            <div class="bg-gray-700/50 rounded-lg p-4 text-center">
                                <div class="text-3xl font-bold" 
                                     :class="validationStats.pValue < 0.05 ? 'text-green-400' : 'text-orange-400'"
                                     x-text="validationStats.pValue < 0.001 ? '<0.001' : validationStats.pValue.toFixed(3)"></div>
                                <div class="text-xs text-gray-400 mt-1">p-value</div>
                            </div>
                        </div>

                        <!-- Confidence Interpretation -->
                        <div class="rounded-lg p-4 mb-6"
                             :class="validationStats.reviewed < 5 ? 'bg-gray-700/30 border border-gray-600' : 
                                     validationStats.pValue < 0.05 ? 'bg-green-500/10 border border-green-500/30' : 
                                     'bg-orange-500/10 border border-orange-500/30'">
                            <div class="flex items-center gap-3">
                                <span class="text-2xl" x-text="validationStats.reviewed < 5 ? 'üìä' : validationStats.pValue < 0.05 ? '‚úÖ' : '‚ö†Ô∏è'"></span>
                                <div>
                                    <div class="font-medium" x-text="getConfidenceMessage()"></div>
                                    <div class="text-sm text-gray-400" x-text="getConfidenceDetail()"></div>
                                </div>
                            </div>
                            <!-- Progress to significance -->
                            <div x-show="validationStats.reviewed < validationStats.sampleSizeNeeded" class="mt-3">
                                <div class="flex justify-between text-xs text-gray-400 mb-1">
                                    <span>Progression vers significativit√©</span>
                                    <span x-text="validationStats.reviewed + '/' + validationStats.sampleSizeNeeded + ' produits'"></span>
                                </div>
                                <div class="w-full bg-gray-700 rounded-full h-2">
                                    <div class="bg-blue-500 h-2 rounded-full transition-all" 
                                         :style="'width: ' + Math.min(100, (validationStats.reviewed / validationStats.sampleSizeNeeded) * 100) + '%'"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Margin of Error Display -->
                        <div x-show="validationStats.reviewed >= 5" class="bg-gray-700/30 rounded-lg p-4">
                            <div class="text-sm text-gray-400 mb-2">Intervalle de confiance √† 95%</div>
                            <div class="flex items-center gap-4">
                                <div class="flex-1 relative h-8 bg-gray-700 rounded">
                                    <!-- Confidence interval bar -->
                                    <div class="absolute h-full bg-blue-500/30 rounded"
                                         :style="'left: ' + Math.max(0, (validationStats.approvalRate - validationStats.marginOfError) * 100) + '%; width: ' + (validationStats.marginOfError * 200) + '%'"></div>
                                    <!-- Point estimate -->
                                    <div class="absolute top-0 h-full w-1 bg-blue-500"
                                         :style="'left: ' + (validationStats.approvalRate * 100) + '%'"></div>
                                    <!-- Scale markers -->
                                    <div class="absolute bottom-0 left-0 w-full flex justify-between text-xs text-gray-500 -mb-5">
                                        <span>0%</span>
                                        <span>50%</span>
                                        <span>100%</span>
                                    </div>
                                </div>
                                <div class="text-sm whitespace-nowrap">
                                    <span class="text-blue-400 font-medium" x-text="((validationStats.approvalRate - validationStats.marginOfError) * 100).toFixed(0) + '% - ' + ((validationStats.approvalRate + validationStats.marginOfError) * 100).toFixed(0) + '%'"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Current Product Validation -->
                    <div x-show="currentValidationProduct" class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden">
                        <!-- Product Header -->
                        <div class="p-4 bg-gradient-to-r from-blue-600 to-purple-600 flex items-center gap-4">
                            <div class="w-16 h-16 bg-gray-900 rounded-lg overflow-hidden flex-shrink-0">
                                <img :src="getProductImage(currentValidationProduct)" 
                                     @error="$event.target.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23374151%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2255%22 text-anchor=%22middle%22 fill=%22%239CA3AF%22 font-size=%2230%22>üì¶</text></svg>'"
                                     class="w-full h-full object-cover">
                            </div>
                            <div class="flex-1">
                                <div class="text-sm text-blue-100">Produit <span x-text="validationStats.currentIndex + 1"></span> / <span x-text="validationSample.length"></span></div>
                                <div class="font-bold text-lg" x-text="getProductTitle(currentValidationProduct)"></div>
                                <div class="text-sm text-blue-200" x-text="currentValidationProduct?.external_id"></div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm text-blue-100">Score actuel</div>
                                <div class="text-2xl font-bold" x-text="((currentValidationProduct?.agent_readiness_score || 0) * 100).toFixed(0) + '%'"></div>
                            </div>
                        </div>

                        <!-- Proposals for this product -->
                        <div class="p-6 space-y-4">
                            <template x-for="(proposal, idx) in currentProductProposals" :key="proposal.id">
                                <div class="bg-gray-700/30 rounded-lg border border-gray-600 overflow-hidden">
                                    <!-- Proposal Header -->
                                    <div class="px-4 py-3 bg-gray-700/50 flex justify-between items-center">
                                        <div class="flex items-center gap-3">
                                            <span class="text-lg" x-text="getFieldIcon(proposal.field)"></span>
                                            <div>
                                                <div class="font-medium" x-text="proposal.field"></div>
                                                <div class="text-xs text-gray-400">
                                                    Confiance: <span x-text="(proposal.confidence * 100).toFixed(0) + '%'"></span>
                                                    ‚Ä¢ Risque: <span :class="proposal.risk_level === 'low' ? 'text-green-400' : proposal.risk_level === 'medium' ? 'text-yellow-400' : 'text-red-400'" x-text="proposal.risk_level"></span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span class="text-xs px-2 py-1 rounded"
                                                  :class="proposal.validation_status === 'approved' ? 'bg-green-500/20 text-green-400' : 
                                                          proposal.validation_status === 'rejected' ? 'bg-red-500/20 text-red-400' : 
                                                          proposal.validation_status === 'edited' ? 'bg-blue-500/20 text-blue-400' : 'bg-gray-600 text-gray-400'"
                                                  x-text="proposal.validation_status || 'pending'"></span>
                                        </div>
                                    </div>

                                    <!-- Rationale -->
                                    <div class="px-4 py-3 bg-purple-500/5 border-b border-gray-600">
                                        <div class="text-xs text-purple-400 font-medium mb-1">üí° Rationnel de l'optimisation</div>
                                        <p class="text-sm text-gray-300" x-text="proposal.rationale || generateRationale(proposal)"></p>
                                        <!-- Sources -->
                                        <div x-show="proposal.sources?.length" class="mt-2 flex flex-wrap gap-1">
                                            <template x-for="source in (proposal.sources || [])" :key="source">
                                                <span class="text-xs px-2 py-0.5 rounded bg-gray-700 text-gray-400">
                                                    üìé <span x-text="source"></span>
                                                </span>
                                            </template>
                                        </div>
                                    </div>

                                    <!-- Before / After Comparison -->
                                    <div class="p-4 grid grid-cols-2 gap-4">
                                        <div>
                                            <div class="text-xs text-gray-500 mb-1">Avant</div>
                                            <div class="bg-red-500/10 border border-red-500/30 rounded p-3 text-sm" x-text="proposal.before_value || '(vide)'"></div>
                                        </div>
                                        <div>
                                            <div class="text-xs text-gray-500 mb-1">Apr√®s (proposition)</div>
                                            <div x-show="!proposal.editing" 
                                                 class="bg-green-500/10 border border-green-500/30 rounded p-3 text-sm cursor-pointer hover:border-green-400"
                                                 @click="proposal.editing = true; proposal.editValue = proposal.edited_value || proposal.after_value"
                                                 x-text="proposal.edited_value || proposal.after_value"></div>
                                            <div x-show="proposal.editing" class="space-y-2">
                                                <textarea x-model="proposal.editValue" 
                                                          class="w-full bg-gray-900 border border-blue-500 rounded p-3 text-sm focus:outline-none"
                                                          rows="3"></textarea>
                                                <div class="flex gap-2">
                                                    <button @click="saveProposalEdit(proposal)" 
                                                            class="px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">Sauvegarder</button>
                                                    <button @click="proposal.editing = false" 
                                                            class="px-3 py-1 bg-gray-600 text-white text-xs rounded hover:bg-gray-700">Annuler</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Individual Proposal Actions -->
                                    <div class="px-4 py-3 bg-gray-700/30 flex justify-between items-center">
                                        <div class="text-xs text-gray-500">
                                            Cliquez sur "Apr√®s" pour √©diter manuellement
                                        </div>
                                        <div class="flex gap-2">
                                            <button @click="validateProposal(proposal, 'rejected')" 
                                                    :class="proposal.validation_status === 'rejected' ? 'bg-red-600' : 'bg-gray-600 hover:bg-red-600'"
                                                    class="px-3 py-1.5 text-white text-sm rounded transition-colors">
                                                ‚ùå Rejeter
                                            </button>
                                            <button @click="validateProposal(proposal, 'approved')" 
                                                    :class="proposal.validation_status === 'approved' ? 'bg-green-600' : 'bg-gray-600 hover:bg-green-600'"
                                                    class="px-3 py-1.5 text-white text-sm rounded transition-colors">
                                                ‚úÖ Approuver
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </template>

                            <!-- No proposals -->
                            <div x-show="currentProductProposals.length === 0" class="text-center py-8 text-gray-500">
                                <div class="text-4xl mb-2">üì≠</div>
                                <p>Aucune proposition pour ce produit</p>
                            </div>
                        </div>

                        <!-- Product Navigation -->
                        <div class="p-4 border-t border-gray-700 bg-gray-900/50 flex justify-between items-center">
                            <button @click="previousValidationProduct()" 
                                    :disabled="validationStats.currentIndex === 0"
                                    class="px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600 disabled:opacity-50">
                                ‚Üê Pr√©c√©dent
                            </button>
                            <div class="flex gap-2">
                                <button @click="skipProduct()" 
                                        class="px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600">
                                    Passer ‚Ü∑
                                </button>
                                <button @click="validateProduct('rejected')" 
                                        class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                                    ‚ùå Rejeter tout
                                </button>
                                <button @click="validateProduct('approved')" 
                                        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                    ‚úÖ Approuver tout
                                </button>
                            </div>
                            <button @click="nextValidationProduct()" 
                                    :disabled="validationStats.currentIndex >= validationSample.length - 1"
                                    class="px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600 disabled:opacity-50">
                                Suivant ‚Üí
                            </button>
                        </div>
                    </div>

                    <!-- Empty State -->
                    <div x-show="!currentValidationProduct && validationDataset" class="bg-gray-800 rounded-xl p-12 border border-gray-700 text-center">
                        <div class="text-6xl mb-4">üé≤</div>
                        <h3 class="text-xl font-bold mb-2">Pr√™t √† valider</h3>
                        <p class="text-gray-400 mb-4">Cliquez sur "Nouvel √©chantillon" pour commencer la validation</p>
                    </div>

                    <!-- Validation Complete -->
                    <div x-show="validationComplete" class="bg-gray-800 rounded-xl p-8 border border-gray-700">
                        <div class="text-center mb-6">
                            <div class="text-6xl mb-4" x-text="validationStats.approvalRate >= 0.8 ? 'üéâ' : validationStats.approvalRate >= 0.6 ? 'üëç' : '‚ö†Ô∏è'"></div>
                            <h3 class="text-2xl font-bold mb-2">Validation termin√©e</h3>
                        </div>

                        <div class="grid grid-cols-2 gap-6 max-w-2xl mx-auto">
                            <div class="bg-gray-700/30 rounded-lg p-4">
                                <div class="text-sm text-gray-400 mb-1">Taux d'approbation</div>
                                <div class="text-3xl font-bold" 
                                     :class="validationStats.approvalRate >= 0.8 ? 'text-green-400' : validationStats.approvalRate >= 0.6 ? 'text-yellow-400' : 'text-red-400'"
                                     x-text="(validationStats.approvalRate * 100).toFixed(1) + '%'"></div>
                            </div>
                            <div class="bg-gray-700/30 rounded-lg p-4">
                                <div class="text-sm text-gray-400 mb-1">Intervalle de confiance (95%)</div>
                                <div class="text-3xl font-bold text-blue-400" 
                                     x-text="'¬±' + (validationStats.marginOfError * 100).toFixed(1) + '%'"></div>
                            </div>
                        </div>

                        <div class="mt-6 p-4 rounded-lg text-center"
                             :class="validationStats.pValue < 0.05 ? 'bg-green-500/10 border border-green-500/30' : 'bg-orange-500/10 border border-orange-500/30'">
                            <p class="text-lg" x-text="validationStats.pValue < 0.05 ? 
                                'R√©sultat statistiquement significatif ! Vous pouvez appliquer ces optimisations avec confiance.' : 
                                '√âchantillon trop petit pour une conclusion d√©finitive. Continuez la validation.'"></p>
                        </div>

                        <div class="mt-6 flex justify-center gap-4">
                            <button @click="loadValidationSample()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                üîÑ Nouvel √©chantillon
                            </button>
                            <button @click="applyApprovedProposals()" 
                                    :disabled="validationStats.approvalRate < 0.5"
                                    class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50">
                                ‚úÖ Appliquer les optimisations approuv√©es
                            </button>
                        </div>
                    </div>

                    <!-- Validation History -->
                    <div x-show="validationHistory.length > 0" class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                        <h3 class="font-bold mb-4">üìú Historique de validation</h3>
                        <div class="space-y-2 max-h-48 overflow-y-auto">
                            <template x-for="(item, idx) in validationHistory" :key="idx">
                                <div class="flex items-center justify-between text-sm bg-gray-700/30 rounded px-3 py-2">
                                    <div class="flex items-center gap-2">
                                        <span x-text="item.status === 'approved' ? '‚úÖ' : item.status === 'rejected' ? '‚ùå' : '‚Ü∑'"></span>
                                        <span x-text="item.productId"></span>
                                        <span class="text-gray-500">‚Ä¢</span>
                                        <span class="text-gray-400" x-text="item.proposalCount + ' proposals'"></span>
                                    </div>
                                    <span class="text-xs text-gray-500" x-text="item.time"></span>
                                </div>
                            </template>
                        </div>
                    </div>
                </div><!-- End Validation Tab -->

                <!-- ============ SETTINGS TAB ============ -->
                <div x-show="currentTab === 'settings'" x-init="loadPrompts()" class="space-y-6">
                    
                    <!-- Editable Prompts Section -->
                    <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h2 class="text-xl font-bold flex items-center gap-2">ü§ñ Agent Prompts</h2>
                                <p class="text-gray-400 text-sm mt-1">Edit the prompts used by the AI agent at each step</p>
                            </div>
                            <button @click="loadPrompts()" class="text-blue-400 hover:text-blue-300 text-sm">‚Üª Refresh</button>
                        </div>
                        
                        <div x-show="prompts.length === 0" class="text-center text-gray-500 py-8">
                            Loading prompts...
                        </div>
                        
                        <div class="space-y-4">
                            <template x-for="prompt in prompts" :key="prompt.id">
                                <div class="bg-gray-700/30 rounded-lg border border-gray-600 overflow-hidden">
                                    <!-- Prompt Header -->
                                    <div class="flex justify-between items-center px-4 py-3 bg-gray-700/50 cursor-pointer"
                                         @click="togglePrompt(prompt.id)">
                                        <div class="flex items-center gap-3">
                                            <span class="text-lg" x-text="getPromptIcon(prompt.id)"></span>
                                            <div>
                                                <div class="font-medium" x-text="prompt.name"></div>
                                                <div class="text-xs text-gray-400" x-text="prompt.description"></div>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-3">
                                            <span class="text-xs px-2 py-1 rounded"
                                                  :class="prompt.category === 'agent' ? 'bg-purple-500/20 text-purple-400' : 'bg-blue-500/20 text-blue-400'"
                                                  x-text="prompt.category"></span>
                                            <span class="text-gray-400 transform transition-transform"
                                                  :class="expandedPrompts.includes(prompt.id) ? 'rotate-180' : ''">‚ñº</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Prompt Content (expandable) -->
                                    <div x-show="expandedPrompts.includes(prompt.id)" 
                                         x-transition:enter="transition ease-out duration-200"
                                         x-transition:enter-start="opacity-0 -translate-y-2"
                                         x-transition:enter-end="opacity-100 translate-y-0"
                                         class="p-4 border-t border-gray-600">
                                        <textarea :id="'prompt-' + prompt.id"
                                                  x-model="promptEdits[prompt.id]"
                                                  @input="markPromptDirty(prompt.id)"
                                                  class="w-full h-64 bg-gray-900 border border-gray-600 rounded-lg px-4 py-3 text-sm font-mono text-gray-300 focus:outline-none focus:border-blue-500 resize-y"
                                                  placeholder="Enter prompt content..."></textarea>
                                        
                                        <!-- Variables hint -->
                                        <div class="mt-2 text-xs text-gray-500">
                                            <span class="font-medium">Available variables:</span>
                                            <span x-show="prompt.id === 'system_prompt'">{{goal}}</span>
                                            <span x-show="prompt.id === 'analyze_product'">{{product_data}}</span>
                                            <span x-show="prompt.id === 'analyze_image'">{{questions}}</span>
                                            <span x-show="prompt.id === 'optimize_title' || prompt.id === 'optimize_description'">{{current_value}}, {{context}}, {{constraints}}</span>
                                        </div>
                                        
                                        <!-- Actions -->
                                        <div class="flex justify-between items-center mt-4">
                                            <div class="text-xs text-gray-500">
                                                Last updated: <span x-text="new Date(prompt.updated_at).toLocaleString()"></span>
                                            </div>
                                            <div class="flex gap-2">
                                                <button @click="resetPromptEdit(prompt)"
                                                        :disabled="!dirtyPrompts.includes(prompt.id)"
                                                        class="px-3 py-1.5 text-sm text-gray-400 hover:text-white disabled:opacity-30">
                                                    Reset
                                                </button>
                                                <button @click="savePrompt(prompt.id)"
                                                        :disabled="!dirtyPrompts.includes(prompt.id) || savingPrompt === prompt.id"
                                                        class="px-4 py-1.5 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 disabled:opacity-50">
                                                    <span x-show="savingPrompt !== prompt.id">Save Changes</span>
                                                    <span x-show="savingPrompt === prompt.id" class="pulse">Saving...</span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Reference: GMC Rules -->
                    <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                        <h2 class="text-xl font-bold mb-6 flex items-center gap-2">üìã GMC Reference</h2>
                        
                        <!-- Collapsible sections -->
                        <details class="mb-4">
                            <summary class="cursor-pointer text-blue-400 font-medium py-2">üìù Title Templates by Category</summary>
                            <div class="mt-3 space-y-2 pl-4">
                                <div class="bg-gray-700/30 rounded p-3">
                                    <span class="font-medium">üëï Apparel:</span>
                                    <code class="text-sm text-green-400 ml-2">{brand} + {gender} + {type} + {color} + {size} + {material}</code>
                                </div>
                                <div class="bg-gray-700/30 rounded p-3">
                                    <span class="font-medium">üì± Electronics:</span>
                                    <code class="text-sm text-green-400 ml-2">{brand} + {line} + {model} + {key_spec} + {capacity}</code>
                                </div>
                                <div class="bg-gray-700/30 rounded p-3">
                                    <span class="font-medium">üè† Home:</span>
                                    <code class="text-sm text-green-400 ml-2">{brand} + {type} + {material} + {dimensions} + {style}</code>
                                </div>
                                <div class="bg-gray-700/30 rounded p-3">
                                    <span class="font-medium">üíÑ Beauty:</span>
                                    <code class="text-sm text-green-400 ml-2">{brand} + {line} + {type} + {variant} + {size}</code>
                                </div>
                            </div>
                        </details>
                        
                        <details class="mb-4">
                            <summary class="cursor-pointer text-red-400 font-medium py-2">üî¥ Critical Validation Rules</summary>
                            <div class="mt-3 grid grid-cols-3 gap-2 pl-4">
                                <div class="bg-red-500/10 rounded p-2 text-sm">üö´ Policy Violations</div>
                                <div class="bg-red-500/10 rounded p-2 text-sm">üí∞ Price Mismatch</div>
                                <div class="bg-red-500/10 rounded p-2 text-sm">üì¶ Availability</div>
                                <div class="bg-red-500/10 rounded p-2 text-sm">üîó Invalid URLs</div>
                                <div class="bg-red-500/10 rounded p-2 text-sm">üè∑Ô∏è Invalid GTIN</div>
                                <div class="bg-red-500/10 rounded p-2 text-sm">üñºÔ∏è Image Policy</div>
                            </div>
                        </details>
                        
                        <details class="mb-4">
                            <summary class="cursor-pointer text-orange-400 font-medium py-2">üü† Required Attributes</summary>
                            <div class="mt-3 flex flex-wrap gap-2 pl-4">
                                <span class="bg-orange-500/10 px-3 py-1 rounded text-sm">id</span>
                                <span class="bg-orange-500/10 px-3 py-1 rounded text-sm">title</span>
                                <span class="bg-orange-500/10 px-3 py-1 rounded text-sm">description</span>
                                <span class="bg-orange-500/10 px-3 py-1 rounded text-sm">brand</span>
                                <span class="bg-orange-500/10 px-3 py-1 rounded text-sm">gtin/mpn</span>
                                <span class="bg-orange-500/10 px-3 py-1 rounded text-sm">condition</span>
                            </div>
                        </details>
                        
                        <details class="mb-4">
                            <summary class="cursor-pointer text-yellow-400 font-medium py-2">üü° Recommended Attributes</summary>
                            <div class="mt-3 flex flex-wrap gap-2 pl-4">
                                <span class="bg-yellow-500/10 px-3 py-1 rounded text-sm">google_product_category</span>
                                <span class="bg-yellow-500/10 px-3 py-1 rounded text-sm">product_type</span>
                                <span class="bg-yellow-500/10 px-3 py-1 rounded text-sm">color</span>
                                <span class="bg-yellow-500/10 px-3 py-1 rounded text-sm">size</span>
                                <span class="bg-yellow-500/10 px-3 py-1 rounded text-sm">material</span>
                                <span class="bg-yellow-500/10 px-3 py-1 rounded text-sm">gender</span>
                            </div>
                        </details>
                        
                        <details>
                            <summary class="cursor-pointer text-green-400 font-medium py-2">‚úÖ Title Best Practices</summary>
                            <div class="mt-3 grid grid-cols-2 gap-4 pl-4">
                                <div class="space-y-1 text-sm">
                                    <div class="text-green-400">‚úÖ Front-load keywords (70 chars visible)</div>
                                    <div class="text-green-400">‚úÖ Include color, size attributes</div>
                                    <div class="text-green-400">‚úÖ Max 150 chars, optimal 70-100</div>
                                </div>
                                <div class="space-y-1 text-sm">
                                    <div class="text-red-400">‚ùå ALL CAPS ABUSE</div>
                                    <div class="text-red-400">‚ùå Promo text: SALE, -50%</div>
                                    <div class="text-red-400">‚ùå Symbols: ‚òÖ ‚ô• ‚Üí ‚óè</div>
                                </div>
                            </div>
                        </details>
                    </div>
                </div><!-- End Settings Tab -->

                <!-- ============ DOCUMENTATION TAB ============ -->
                <div x-show="currentTab === 'docs'" class="space-y-6">
                    <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                        <h2 class="text-xl font-bold mb-6 flex items-center gap-2">üìñ Documentation</h2>
                        
                        <!-- Core Principle -->
                        <div class="mb-8 bg-purple-500/10 border border-purple-500/30 rounded-lg p-4">
                            <h3 class="text-lg font-semibold mb-3 text-purple-400">üéØ Core Principle</h3>
                            <p class="text-gray-300 mb-3">Never allow the same agent to <strong>evaluate</strong>, <strong>decide</strong>, AND <strong>generate</strong>.</p>
                            <p class="text-sm text-gray-400">These responsibilities are strictly separated across 6 specialized agents.</p>
                        </div>

                        <!-- 6-Agent Pipeline -->
                        <div class="mb-8">
                            <h3 class="text-lg font-semibold mb-4 text-blue-400">üîÑ 6-Agent Pipeline</h3>
                            <div class="bg-gray-700/30 rounded-lg p-4">
                                <div class="flex items-center justify-between gap-2 text-center mb-6">
                                    <div class="flex-1 bg-gray-700/50 rounded-lg p-2">
                                        <div class="text-xl mb-1">‚úì</div>
                                        <div class="font-medium text-xs">Validate</div>
                                        <p class="text-xs text-gray-500">Rules</p>
                                    </div>
                                    <span class="text-gray-600">‚Üí</span>
                                    <div class="flex-1 bg-blue-500/20 rounded-lg p-2">
                                        <div class="text-xl mb-1">‚öñÔ∏è</div>
                                        <div class="font-medium text-xs">Audit</div>
                                        <p class="text-xs text-gray-500">Judge</p>
                                    </div>
                                    <span class="text-gray-600">‚Üí</span>
                                    <div class="flex-1 bg-purple-500/20 rounded-lg p-2">
                                        <div class="text-xl mb-1">üëÅÔ∏è</div>
                                        <div class="font-medium text-xs">Evidence</div>
                                        <p class="text-xs text-gray-500">Vision</p>
                                    </div>
                                    <span class="text-gray-600">‚Üí</span>
                                    <div class="flex-1 bg-cyan-500/20 rounded-lg p-2">
                                        <div class="text-xl mb-1">üîç</div>
                                        <div class="font-medium text-xs">Retrieval</div>
                                        <p class="text-xs text-gray-500">Facts</p>
                                    </div>
                                    <span class="text-gray-600">‚Üí</span>
                                    <div class="flex-1 bg-yellow-500/20 rounded-lg p-2">
                                        <div class="text-xl mb-1">üìã</div>
                                        <div class="font-medium text-xs">Plan</div>
                                        <p class="text-xs text-gray-500">Decide</p>
                                    </div>
                                    <span class="text-gray-600">‚Üí</span>
                                    <div class="flex-1 bg-orange-500/20 rounded-lg p-2">
                                        <div class="text-xl mb-1">‚úèÔ∏è</div>
                                        <div class="font-medium text-xs">Write</div>
                                        <p class="text-xs text-gray-500">Generate</p>
                                    </div>
                                    <span class="text-gray-600">‚Üí</span>
                                    <div class="flex-1 bg-red-500/20 rounded-lg p-2">
                                        <div class="text-xl mb-1">üõ°Ô∏è</div>
                                        <div class="font-medium text-xs">Control</div>
                                        <p class="text-xs text-gray-500">Reject?</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Agent Details -->
                        <div class="mb-8">
                            <h3 class="text-lg font-semibold mb-4 text-purple-400">ü§ñ The 6 Agents</h3>
                            <div class="space-y-3">
                                <!-- Auditor -->
                                <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4">
                                    <div class="flex items-center gap-3 mb-2">
                                        <span class="text-2xl">‚öñÔ∏è</span>
                                        <div>
                                            <div class="font-bold text-blue-400">Product Auditor</div>
                                            <div class="text-xs text-gray-500">JUDGE ONLY</div>
                                        </div>
                                    </div>
                                    <p class="text-sm text-gray-400 mb-2">Outputs structured diagnostics: violations, weaknesses, scores.</p>
                                    <div class="text-xs text-red-400">‚ùå No rewriting ‚Ä¢ No suggestions ‚Ä¢ No creativity</div>
                                </div>
                                
                                <!-- Evidence -->
                                <div class="bg-purple-500/10 border border-purple-500/30 rounded-lg p-4">
                                    <div class="flex items-center gap-3 mb-2">
                                        <span class="text-2xl">üëÅÔ∏è</span>
                                        <div>
                                            <div class="font-bold text-purple-400">Image Evidence Agent</div>
                                            <div class="text-xs text-gray-500">DETECT ONLY</div>
                                        </div>
                                    </div>
                                    <p class="text-sm text-gray-400 mb-2">Allowed: detect, confirm, deny, mark uncertainty.</p>
                                    <div class="text-xs text-red-400">‚ùå No inference ‚Ä¢ No adjectives ‚Ä¢ No marketing language</div>
                                </div>
                                
                                <!-- Retrieval -->
                                <div class="bg-cyan-500/10 border border-cyan-500/30 rounded-lg p-4">
                                    <div class="flex items-center gap-3 mb-2">
                                        <span class="text-2xl">üîç</span>
                                        <div>
                                            <div class="font-bold text-cyan-400">Knowledge Retrieval Agent</div>
                                            <div class="text-xs text-gray-500">FETCH FACTS</div>
                                        </div>
                                    </div>
                                    <p class="text-sm text-gray-400 mb-2">Every fact has: source URL + evidence snippet + confidence.</p>
                                    <div class="text-xs text-green-400">‚úì This is how we eliminate hallucination</div>
                                </div>
                                
                                <!-- Planner -->
                                <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4">
                                    <div class="flex items-center gap-3 mb-2">
                                        <span class="text-2xl">üìã</span>
                                        <div>
                                            <div class="font-bold text-yellow-400">Optimization Planner</div>
                                            <div class="text-xs text-gray-500">DECIDE ONLY</div>
                                        </div>
                                    </div>
                                    <p class="text-sm text-gray-400 mb-2">Decides WHAT to optimize, classifies risk, identifies human gates.</p>
                                    <div class="text-xs text-red-400">‚ùå No text generation ‚Ä¢ Decision logic only</div>
                                </div>
                                
                                <!-- Writer -->
                                <div class="bg-orange-500/10 border border-orange-500/30 rounded-lg p-4">
                                    <div class="flex items-center gap-3 mb-2">
                                        <span class="text-2xl">‚úèÔ∏è</span>
                                        <div>
                                            <div class="font-bold text-orange-400">Copy Execution Agent</div>
                                            <div class="text-xs text-gray-500">WRITE UNDER CONSTRAINTS</div>
                                        </div>
                                    </div>
                                    <p class="text-sm text-gray-400 mb-2">Receives: allowed_facts, forbidden_facts, constraints, objective.</p>
                                    <div class="text-xs text-red-400">‚ùå Cannot invent ‚Ä¢ Every fact traceable</div>
                                </div>
                                
                                <!-- Controller -->
                                <div class="bg-red-500/10 border border-red-500/30 rounded-lg p-4">
                                    <div class="flex items-center gap-3 mb-2">
                                        <span class="text-2xl">üõ°Ô∏è</span>
                                        <div>
                                            <div class="font-bold text-red-400">Controller Agent</div>
                                            <div class="text-xs text-gray-500">EXISTS ONLY TO SAY NO</div>
                                        </div>
                                    </div>
                                    <p class="text-sm text-gray-400 mb-2">Compares before/after, verifies facts, checks rules. If wrong ‚Üí REJECT.</p>
                                    <div class="text-xs text-green-400">‚úì This is what makes enterprises trust the system</div>
                                </div>
                            </div>
                        </div>

                        <!-- Supporting Tools -->
                        <div class="mb-8">
                            <h3 class="text-lg font-semibold mb-4 text-green-400">üõ†Ô∏è Deterministic Tools</h3>
                            <div class="grid grid-cols-2 gap-3">
                                <div class="bg-gray-700/30 rounded-lg p-3">
                                    <div class="font-medium text-sm mb-1">Hard Rule Validator</div>
                                    <p class="text-xs text-gray-500">Deterministic ‚Ä¢ Reproducible ‚Ä¢ Explainable</p>
                                </div>
                                <div class="bg-gray-700/30 rounded-lg p-3">
                                    <div class="font-medium text-sm mb-1">Diff Engine</div>
                                    <p class="text-xs text-gray-500">Shows exactly what changed</p>
                                </div>
                                <div class="bg-gray-700/30 rounded-lg p-3">
                                    <div class="font-medium text-sm mb-1">Evidence Registry</div>
                                    <p class="text-xs text-gray-500">Every fact ‚Üí source (feed/image/web)</p>
                                </div>
                                <div class="bg-gray-700/30 rounded-lg p-3">
                                    <div class="font-medium text-sm mb-1">Risk Classifier</div>
                                    <p class="text-xs text-gray-500">LOW/MEDIUM/HIGH ‚Üí human gate</p>
                                </div>
                            </div>
                        </div>

                        <!-- Why This Architecture -->
                        <div class="bg-green-500/10 border border-green-500/30 rounded-lg p-4">
                            <h3 class="text-lg font-semibold mb-3 text-green-400">‚úÖ What This Enables</h3>
                            <p class="text-sm text-gray-300 mb-3">The system can now say:</p>
                            <ul class="space-y-1 text-sm text-gray-400">
                                <li>‚Ä¢ <strong>What</strong> changed</li>
                                <li>‚Ä¢ <strong>Why</strong> it changed</li>
                                <li>‚Ä¢ Based on <strong>which evidence</strong></li>
                                <li>‚Ä¢ With <strong>what confidence</strong></li>
                                <li>‚Ä¢ Under <strong>which rule version</strong></li>
                                <li>‚Ä¢ And whether a <strong>human approved</strong> it</li>
                            </ul>
                        </div>
                    </div>
                </div><!-- End Docs Tab -->
                
            </main>
        </div>

        <!-- Right Panel: Pipeline View -->
        <div x-show="showLogPanel" 
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="translate-x-full"
             x-transition:enter-end="translate-x-0"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="translate-x-0"
             x-transition:leave-end="translate-x-full"
             class="fixed right-0 top-0 h-full w-[420px] bg-gray-800 border-l border-gray-700 flex flex-col shadow-2xl z-40">
            
            <!-- Panel Header -->
            <div class="p-4 border-b border-gray-700 bg-gradient-to-r from-blue-600 to-purple-600">
                <div class="flex justify-between items-center">
                    <h3 class="font-bold text-white flex items-center gap-2">
                        üîÑ Pipeline Activity
                        <span x-show="globalEnriching || currentEnrichingProduct" class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
                    </h3>
                    <button @click="clearLogs" class="text-white/70 hover:text-white text-sm">Clear</button>
                </div>
                <p class="text-blue-100 text-sm mt-1">6-Agent Pipeline ‚Ä¢ Evidence-Based ‚Ä¢ Human-Gated</p>
            </div>

            <!-- Pipeline Stages Overview -->
            <div class="p-3 bg-gray-900/50 border-b border-gray-700">
                <div class="flex items-center justify-between text-xs">
                    <div class="flex items-center gap-1" :class="pipelineStage >= 1 ? 'text-green-400' : 'text-gray-500'">
                        <span>‚úì</span><span>Validate</span>
                    </div>
                    <span class="text-gray-600">‚Üí</span>
                    <div class="flex items-center gap-1" :class="pipelineStage >= 2 ? 'text-blue-400' : 'text-gray-500'">
                        <span>‚öñÔ∏è</span><span>Audit</span>
                    </div>
                    <span class="text-gray-600">‚Üí</span>
                    <div class="flex items-center gap-1" :class="pipelineStage >= 3 ? 'text-purple-400' : 'text-gray-500'">
                        <span>üëÅÔ∏è</span><span>Evidence</span>
                    </div>
                    <span class="text-gray-600">‚Üí</span>
                    <div class="flex items-center gap-1" :class="pipelineStage >= 4 ? 'text-yellow-400' : 'text-gray-500'">
                        <span>üìã</span><span>Plan</span>
                    </div>
                    <span class="text-gray-600">‚Üí</span>
                    <div class="flex items-center gap-1" :class="pipelineStage >= 5 ? 'text-orange-400' : 'text-gray-500'">
                        <span>‚úèÔ∏è</span><span>Write</span>
                    </div>
                    <span class="text-gray-600">‚Üí</span>
                    <div class="flex items-center gap-1" :class="pipelineStage >= 6 ? 'text-red-400' : 'text-gray-500'">
                        <span>üõ°Ô∏è</span><span>Control</span>
                    </div>
                </div>
            </div>

            <!-- Stats Bar -->
            <div class="p-3 bg-gray-900/30 border-b border-gray-700 grid grid-cols-4 gap-2 text-center">
                <div>
                    <div class="text-xl font-bold text-blue-400" x-text="agentStats.productsProcessed"></div>
                    <div class="text-xs text-gray-400">Processed</div>
                </div>
                <div>
                    <div class="text-xl font-bold text-green-400" x-text="agentStats.proposalsGenerated"></div>
                    <div class="text-xs text-gray-400">Approved</div>
                </div>
                <div>
                    <div class="text-xl font-bold text-red-400" x-text="agentStats.rejected || 0"></div>
                    <div class="text-xs text-gray-400">Rejected</div>
                </div>
                <div>
                    <div class="text-xl font-bold text-yellow-400" x-text="agentStats.humanReview || 0"></div>
                    <div class="text-xs text-gray-400">Human</div>
                </div>
            </div>

            <!-- Logs Container -->
            <div class="flex-1 overflow-y-auto p-4 space-y-3 log-scroll" x-ref="logContainer">
                <template x-for="(log, index) in agentLogs" :key="index">
                    <div class="fade-in rounded-lg p-3 text-sm"
                         :class="{
                            'bg-gray-700/30 border border-gray-600': log.type === 'validate',
                            'bg-blue-500/10 border border-blue-500/30': log.type === 'audit',
                            'bg-purple-500/10 border border-purple-500/30': log.type === 'evidence',
                            'bg-cyan-500/10 border border-cyan-500/30': log.type === 'retrieval',
                            'bg-yellow-500/10 border border-yellow-500/30': log.type === 'plan',
                            'bg-orange-500/10 border border-orange-500/30': log.type === 'write',
                            'bg-pink-500/10 border border-pink-500/30': log.type === 'control',
                            'bg-green-500/10 border border-green-500/30': log.type === 'approved',
                            'bg-red-500/10 border border-red-500/30': log.type === 'rejected',
                            'bg-amber-500/10 border border-amber-500/30': log.type === 'human',
                            'bg-gray-700/50 border border-gray-600': log.type === 'info'
                         }">
                        <div class="flex items-start gap-2">
                            <span class="text-lg flex-shrink-0" x-text="getPipelineIcon(log.type)"></span>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2">
                                    <span class="font-medium text-white" x-text="log.title"></span>
                                    <span x-show="log.agent" class="text-xs px-1.5 py-0.5 rounded bg-gray-700 text-gray-300" x-text="log.agent"></span>
                                </div>
                                <div class="text-gray-400 text-xs mt-1" x-text="log.message"></div>
                                <!-- Evidence Trail -->
                                <div x-show="log.evidence" class="mt-2 bg-gray-900/50 rounded p-2 text-xs">
                                    <div class="text-gray-500 mb-1">üìé Evidence:</div>
                                    <div class="text-gray-300 font-mono" x-text="log.evidence"></div>
                                </div>
                                <!-- Facts Used -->
                                <div x-show="log.facts" class="mt-2 flex flex-wrap gap-1">
                                    <template x-for="fact in (log.facts || [])" :key="fact">
                                        <span class="text-xs px-1.5 py-0.5 rounded bg-blue-500/20 text-blue-300" x-text="fact"></span>
                                    </template>
                                </div>
                                <!-- Rejection Reason -->
                                <div x-show="log.rejection" class="mt-2 bg-red-500/20 rounded p-2 text-xs text-red-300">
                                    <span class="font-medium">‚ùå Rejected:</span> <span x-text="log.rejection"></span>
                                </div>
                                <!-- Confidence -->
                                <div x-show="log.confidence" class="mt-2 flex items-center gap-2">
                                    <div class="flex-1 bg-gray-700 rounded-full h-1.5">
                                        <div class="h-1.5 rounded-full transition-all"
                                             :class="log.confidence > 0.8 ? 'bg-green-500' : log.confidence > 0.6 ? 'bg-yellow-500' : 'bg-red-500'"
                                             :style="'width: ' + (log.confidence * 100) + '%'"></div>
                                    </div>
                                    <span class="text-xs text-gray-400" x-text="Math.round(log.confidence * 100) + '%'"></span>
                                </div>
                            </div>
                            <span class="text-xs text-gray-500 whitespace-nowrap" x-text="log.time"></span>
                        </div>
                    </div>
                </template>
                
                <!-- Empty state -->
                <div x-show="agentLogs.length === 0" class="text-center py-12 text-gray-500">
                    <div class="text-4xl mb-2">üîÑ</div>
                    <p class="font-medium">6-Agent Pipeline</p>
                    <p class="text-sm mt-2">Validate ‚Üí Audit ‚Üí Evidence ‚Üí Plan ‚Üí Write ‚Üí Control</p>
                    <p class="text-xs mt-4 text-gray-600">Start enriching products to see the pipeline in action</p>
                </div>
                
                <!-- Current Stage Indicator -->
                <div x-show="isAgentThinking" class="flex items-center gap-2 text-blue-400 text-sm">
                    <span class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></span>
                    <span class="typing" x-text="currentStageLabel || 'Processing...'"></span>
                </div>
            </div>

            <!-- Current Operation -->
            <div x-show="currentOperation" class="p-4 border-t border-gray-700 bg-gray-900/50">
                <div class="flex items-center gap-2 text-sm">
                    <span class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></span>
                    <span class="text-gray-300" x-text="currentOperation"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Detail Modal (3 columns) -->
    <div x-show="selectedProduct" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50">
        <div class="bg-gray-800 rounded-xl shadow-2xl w-[95vw] h-[95vh] overflow-hidden flex flex-col border border-gray-700">
            <!-- Header with Image -->
            <div class="p-4 border-b border-gray-700 flex justify-between items-center bg-gradient-to-r from-blue-600 to-purple-600">
                <div class="flex items-center gap-4">
                    <!-- Product Image -->
                    <div class="w-20 h-20 bg-gray-900 rounded-lg overflow-hidden flex-shrink-0 border-2 border-white/20">
                        <img :src="getProductImage(selectedProduct)" 
                             @error="$event.target.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23374151%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2255%22 text-anchor=%22middle%22 fill=%22%239CA3AF%22 font-size=%2230%22>üì¶</text></svg>'"
                             class="w-full h-full object-cover"
                             alt="Product image">
                    </div>
                    <div>
                        <h3 class="font-bold text-xl text-white">Product Enrichment View</h3>
                        <p class="text-blue-100 text-sm">
                            <span x-text="selectedProduct?.external_id"></span> ‚Ä¢ 
                            <span x-text="getProductTitle(selectedProduct)"></span>
                        </p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <button @click="enrichProduct(selectedProduct)" 
                            :disabled="currentEnrichingProduct === selectedProduct?.id"
                            class="bg-white text-blue-600 px-4 py-2 rounded-lg font-medium hover:bg-blue-50 disabled:opacity-50">
                        <span x-show="currentEnrichingProduct !== selectedProduct?.id">ü§ñ Enrich</span>
                        <span x-show="currentEnrichingProduct === selectedProduct?.id" class="pulse">‚è≥ Enriching...</span>
                    </button>
                    <button @click="selectedProduct = null" class="text-white hover:text-blue-200 text-3xl">&times;</button>
                </div>
            </div>
            
            <!-- 3 Column Layout -->
            <div class="flex-1 overflow-hidden grid grid-cols-3 divide-x divide-gray-700">
                <!-- Column 1: Before -->
                <div class="flex flex-col overflow-hidden bg-red-900/10">
                    <div class="p-3 bg-red-500/20 border-b border-gray-700">
                        <h4 class="font-bold text-red-400">üì¶ BEFORE (Original)</h4>
                    </div>
                    <div class="flex-1 overflow-y-auto p-4 space-y-2">
                        <!-- Product Image -->
                        <div x-show="getProductImage(selectedProduct)" class="bg-gray-800/50 rounded p-2 mb-3">
                            <div class="text-xs font-medium text-gray-500 uppercase mb-2">Product Image</div>
                            <img :src="getProductImage(selectedProduct)" 
                                 @error="$event.target.style.display='none'"
                                 class="w-full max-h-48 object-contain rounded bg-white/5">
                        </div>
                        <template x-for="[key, value] in getProductAttributes(selectedProduct?.raw_data)" :key="key">
                            <div class="bg-gray-800/50 rounded p-2">
                                <div class="text-xs font-medium text-gray-500 uppercase" x-text="key"></div>
                                <div class="text-sm mt-1 text-gray-300" x-text="value || '(empty)'"></div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Column 2: Analysis -->
                <div class="flex flex-col overflow-hidden bg-yellow-900/10">
                    <div class="p-3 bg-yellow-500/20 border-b border-gray-700">
                        <h4 class="font-bold text-yellow-400">üîç ANALYSIS & PROPOSALS</h4>
                    </div>
                    <div class="flex-1 overflow-y-auto p-4 space-y-3">
                        <div x-show="productProposals.length === 0" class="text-center py-8 text-gray-500">
                            <p class="text-4xl mb-2">ü§ñ</p>
                            <p>No proposals yet</p>
                        </div>
                        <template x-for="prop in productProposals" :key="prop.id">
                            <div class="bg-gray-800/50 rounded-lg p-3 border"
                                 :class="prop.status === 'accepted' ? 'border-green-500/50' : prop.status === 'rejected' ? 'border-red-500/50' : 'border-yellow-500/50'">
                                <div class="flex justify-between items-start mb-2">
                                    <span class="font-bold text-white" x-text="prop.field"></span>
                                    <span class="text-xs" x-text="(prop.confidence * 100).toFixed(0) + '%'"></span>
                                </div>
                                <div class="space-y-1 text-sm">
                                    <div class="diff-remove px-2 py-1 rounded" x-text="prop.before_value || '(empty)'"></div>
                                    <div class="diff-add px-2 py-1 rounded" x-text="prop.after_value"></div>
                                </div>
                                <div class="mt-2 flex gap-2" x-show="prop.status === 'proposed'">
                                    <button @click="updateProposal(prop.id, 'accept')" class="flex-1 text-xs bg-green-600 text-white py-1 rounded">‚úì Accept</button>
                                    <button @click="updateProposal(prop.id, 'reject')" class="flex-1 text-xs bg-red-600 text-white py-1 rounded">‚úó Reject</button>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Column 3: After -->
                <div class="flex flex-col overflow-hidden bg-green-900/10">
                    <div class="p-3 bg-green-500/20 border-b border-gray-700">
                        <h4 class="font-bold text-green-400">‚ú® AFTER (Optimized)</h4>
                    </div>
                    <div class="flex-1 overflow-y-auto p-4 space-y-2">
                        <template x-for="[key, value] in getOptimizedAttributes()" :key="key">
                            <div class="rounded p-2" :class="hasProposalForField(key) ? 'bg-green-500/20' : 'bg-gray-800/50'">
                                <div class="text-xs font-medium text-gray-500 uppercase flex justify-between">
                                    <span x-text="key"></span>
                                    <span x-show="hasProposalForField(key)" class="text-green-400">‚ú®</span>
                                </div>
                                <div class="text-sm mt-1 text-gray-300" x-text="value || '(empty)'"></div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="p-3 border-t border-gray-700 bg-gray-900/50 flex justify-between">
                <div class="text-sm text-gray-400">
                    <span x-text="productProposals.filter(p => p.status === 'accepted').length"></span> accepted,
                    <span x-text="productProposals.filter(p => p.status === 'proposed').length"></span> pending
                </div>
                <div class="flex gap-2">
                    <button @click="acceptAllProposals()" x-show="productProposals.some(p => p.status === 'proposed')"
                            class="bg-green-600 text-white px-4 py-2 rounded text-sm">Accept All</button>
                    <button @click="selectedProduct = null" class="bg-gray-700 text-white px-4 py-2 rounded text-sm">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function app() {
            return {
                // Data
                datasets: [],
                products: [],
                proposals: [],
                proposalsWithProducts: [],
                datasetStats: {},
                selectedDataset: null,
                selectedProduct: null,
                productProposals: [],
                uploadFile: null,
                uploadName: '',
                uploading: false,
                
                // Proposal filters
                proposalFilters: {
                    field: '',
                    minConfidence: '0',
                    riskLevel: '',
                    status: ''
                },
                
                // Navigation
                currentTab: 'dashboard',
                
                // Prompts state
                prompts: [],
                promptEdits: {},
                expandedPrompts: [],
                dirtyPrompts: [],
                savingPrompt: null,

                // Validation state
                validationDataset: '',
                validationSample: [],
                currentValidationProduct: null,
                currentProductProposals: [],
                validationStats: {
                    reviewed: 0,
                    approved: 0,
                    rejected: 0,
                    currentIndex: 0,
                    approvalRate: 0,
                    confidence: 95,
                    pValue: 1,
                    marginOfError: 0,
                    sampleSizeNeeded: 30
                },
                validationHistory: [],
                validationComplete: false,
                
                // Pipeline state
                pipelineStage: 0,
                currentStageLabel: '',
                
                // Agent state
                showLogPanel: true,
                agentLogs: [],
                agentStats: { productsProcessed: 0, proposalsGenerated: 0, rejected: 0, humanReview: 0 },
                globalEnriching: false,
                currentEnrichingProduct: null,
                enrichProgress: 0,
                isAgentThinking: false,
                currentOperation: null,

                async init() {
                    await this.loadDatasets();
                    await this.loadProposalsWithProducts();
                    setInterval(() => this.loadProposalsWithProducts(), 5000);
                    setInterval(() => this.refreshAllDatasetStats(), 10000);
                },
                
                // Computed filtered proposals
                get filteredProposals() {
                    return this.proposalsWithProducts.filter(p => {
                        if (this.proposalFilters.field && p.field.toLowerCase() !== this.proposalFilters.field.toLowerCase()) {
                            return false;
                        }
                        if (this.proposalFilters.minConfidence && p.confidence < parseFloat(this.proposalFilters.minConfidence)) {
                            return false;
                        }
                        if (this.proposalFilters.riskLevel && p.risk_level !== this.proposalFilters.riskLevel) {
                            return false;
                        }
                        if (this.proposalFilters.status && p.status !== this.proposalFilters.status) {
                            return false;
                        }
                        return true;
                    });
                },

                get pendingValidationCount() {
                    return this.proposalsWithProducts.filter(p => p.status === 'proposed').length;
                },

                async loadDatasetStats(datasetId) {
                    try {
                        const res = await fetch(`/api/datasets/${datasetId}/stats`);
                        const stats = await res.json();
                        this.datasetStats[datasetId] = stats;
                    } catch (e) {
                        console.error('Failed to load dataset stats:', e);
                    }
                },

                async refreshAllDatasetStats() {
                    for (const ds of this.datasets) {
                        await this.loadDatasetStats(ds.id);
                    }
                },

                // Logging
                addLog(type, title, message, details = null) {
                    const time = new Date().toLocaleTimeString();
                    this.agentLogs.unshift({ type, title, message, details, time });
                    if (this.agentLogs.length > 100) this.agentLogs.pop();
                    this.$nextTick(() => {
                        if (this.$refs.logContainer) {
                            this.$refs.logContainer.scrollTop = 0;
                        }
                    });
                },

                // Pipeline-specific logging with extended metadata
                addPipelineLog(type, title, message, options = {}) {
                    const time = new Date().toLocaleTimeString();
                    const log = {
                        type,
                        title,
                        message,
                        time,
                        agent: options.agent || null,
                        evidence: options.evidence || null,
                        facts: options.facts || null,
                        rejection: options.rejection || null,
                        confidence: options.confidence || null
                    };
                    this.agentLogs.unshift(log);
                    if (this.agentLogs.length > 100) this.agentLogs.pop();
                    this.$nextTick(() => {
                        if (this.$refs.logContainer) {
                            this.$refs.logContainer.scrollTop = 0;
                        }
                    });
                },

                clearLogs() {
                    this.agentLogs = [];
                    this.agentStats = { productsProcessed: 0, proposalsGenerated: 0, rejected: 0, humanReview: 0 };
                    this.pipelineStage = 0;
                },

                getLogIcon(type) {
                    const icons = {
                        info: 'üìã', success: '‚úÖ', tool: 'üîß', thinking: 'üí≠', error: '‚ùå', step: '‚û°Ô∏è'
                    };
                    return icons[type] || 'üìå';
                },

                // Pipeline icons
                getPipelineIcon(type) {
                    const icons = {
                        validate: '‚úì',
                        audit: '‚öñÔ∏è',
                        evidence: 'üëÅÔ∏è',
                        retrieval: 'üîç',
                        plan: 'üìã',
                        write: '‚úèÔ∏è',
                        control: 'üõ°Ô∏è',
                        approved: '‚úÖ',
                        rejected: '‚ùå',
                        human: 'üë§',
                        info: 'üìå'
                    };
                    return icons[type] || 'üìå';
                },

                // ============ VALIDATION METHODS ============
                
                initValidation() {
                    // Auto-select first dataset if available
                    if (this.datasets.length > 0 && !this.validationDataset) {
                        this.validationDataset = this.datasets[0].id;
                    }
                },

                async loadValidationSample() {
                    if (!this.validationDataset) return;
                    
                    // Reset validation state
                    this.validationComplete = false;
                    this.validationStats = {
                        reviewed: 0,
                        approved: 0,
                        rejected: 0,
                        currentIndex: 0,
                        approvalRate: 0,
                        confidence: 95,
                        pValue: 1,
                        marginOfError: 0,
                        sampleSizeNeeded: 30
                    };
                    this.validationHistory = [];
                    
                    // Load products from selected dataset
                    const res = await fetch(`/api/datasets/${this.validationDataset}/products`);
                    const data = await res.json();
                    const allProducts = data.data || [];
                    
                    // Get products with proposals
                    const productsWithProposals = allProducts.filter(p => 
                        this.proposalsWithProducts.some(prop => prop.product_id === p.id && prop.status === 'proposed')
                    );
                    
                    // Random shuffle and take sample
                    const shuffled = productsWithProposals.sort(() => Math.random() - 0.5);
                    this.validationSample = shuffled.slice(0, Math.min(50, shuffled.length));
                    
                    // Calculate sample size needed for statistical significance
                    const populationSize = productsWithProposals.length;
                    this.validationStats.sampleSizeNeeded = this.calculateSampleSize(populationSize, 0.95, 0.1);
                    
                    // Load first product
                    if (this.validationSample.length > 0) {
                        this.loadValidationProduct(0);
                    }
                },

                loadValidationProduct(index) {
                    if (index < 0 || index >= this.validationSample.length) return;
                    
                    this.validationStats.currentIndex = index;
                    this.currentValidationProduct = this.validationSample[index];
                    
                    // Load proposals for this product
                    this.currentProductProposals = this.proposalsWithProducts
                        .filter(p => p.product_id === this.currentValidationProduct.id && p.status === 'proposed')
                        .map(p => ({
                            ...p,
                            validation_status: null,
                            editing: false,
                            editValue: '',
                            edited_value: null
                        }));
                },

                nextValidationProduct() {
                    if (this.validationStats.currentIndex < this.validationSample.length - 1) {
                        this.loadValidationProduct(this.validationStats.currentIndex + 1);
                    } else {
                        this.validationComplete = true;
                    }
                },

                previousValidationProduct() {
                    if (this.validationStats.currentIndex > 0) {
                        this.loadValidationProduct(this.validationStats.currentIndex - 1);
                    }
                },

                validateProposal(proposal, status) {
                    proposal.validation_status = status;
                },

                async saveProposalEdit(proposal) {
                    proposal.edited_value = proposal.editValue;
                    proposal.editing = false;
                    proposal.validation_status = 'edited';
                    
                    // Save to backend
                    try {
                        await fetch(`/api/proposals/${proposal.id}`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                status: 'proposed',
                                after_value: proposal.editValue 
                            })
                        });
                    } catch (e) {
                        console.error('Failed to save edit:', e);
                    }
                },

                async validateProduct(status) {
                    // Mark all proposals for this product
                    for (const proposal of this.currentProductProposals) {
                        if (!proposal.validation_status) {
                            proposal.validation_status = status;
                        }
                        
                        // Update backend
                        const action = proposal.validation_status === 'approved' ? 'accept' : 
                                       proposal.validation_status === 'rejected' ? 'reject' : null;
                        if (action) {
                            try {
                                await fetch(`/api/proposals/${proposal.id}/${action}`, { method: 'POST' });
                            } catch (e) {
                                console.error('Failed to update proposal:', e);
                            }
                        }
                    }
                    
                    // Update stats
                    this.validationStats.reviewed++;
                    if (status === 'approved') {
                        this.validationStats.approved++;
                    } else {
                        this.validationStats.rejected++;
                    }
                    
                    // Add to history
                    this.validationHistory.unshift({
                        productId: this.currentValidationProduct.external_id,
                        status: status,
                        proposalCount: this.currentProductProposals.length,
                        time: new Date().toLocaleTimeString()
                    });
                    
                    // Recalculate statistics
                    this.updateValidationStatistics();
                    
                    // Move to next product
                    this.nextValidationProduct();
                },

                skipProduct() {
                    this.validationHistory.unshift({
                        productId: this.currentValidationProduct.external_id,
                        status: 'skipped',
                        proposalCount: this.currentProductProposals.length,
                        time: new Date().toLocaleTimeString()
                    });
                    this.nextValidationProduct();
                },

                updateValidationStatistics() {
                    const n = this.validationStats.reviewed;
                    const k = this.validationStats.approved;
                    
                    if (n === 0) {
                        this.validationStats.approvalRate = 0;
                        this.validationStats.marginOfError = 0;
                        this.validationStats.pValue = 1;
                        return;
                    }
                    
                    // Point estimate
                    const p = k / n;
                    this.validationStats.approvalRate = p;
                    
                    // Margin of error (95% CI using Wilson score interval for small samples)
                    const z = 1.96; // 95% confidence
                    const denominator = 1 + z * z / n;
                    const center = (p + z * z / (2 * n)) / denominator;
                    const marginWilson = (z / denominator) * Math.sqrt(p * (1 - p) / n + z * z / (4 * n * n));
                    this.validationStats.marginOfError = marginWilson;
                    
                    // P-value for testing H0: p = 0.5 (null hypothesis: 50% approval)
                    // Using normal approximation for binomial
                    const p0 = 0.5;
                    const se = Math.sqrt(p0 * (1 - p0) / n);
                    const zScore = (p - p0) / se;
                    // Two-tailed p-value
                    this.validationStats.pValue = 2 * (1 - this.normalCDF(Math.abs(zScore)));
                },

                // Normal CDF approximation
                normalCDF(x) {
                    const a1 = 0.254829592;
                    const a2 = -0.284496736;
                    const a3 = 1.421413741;
                    const a4 = -1.453152027;
                    const a5 = 1.061405429;
                    const p = 0.3275911;
                    
                    const sign = x < 0 ? -1 : 1;
                    x = Math.abs(x) / Math.sqrt(2);
                    
                    const t = 1.0 / (1.0 + p * x);
                    const y = 1.0 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-x * x);
                    
                    return 0.5 * (1.0 + sign * y);
                },

                // Calculate required sample size
                calculateSampleSize(population, confidence, marginOfError) {
                    // Z-score for confidence level
                    const zScores = { 0.90: 1.645, 0.95: 1.96, 0.99: 2.576 };
                    const z = zScores[confidence] || 1.96;
                    
                    // Standard formula for sample size with finite population correction
                    const p = 0.5; // Maximum variability
                    const e = marginOfError;
                    
                    const n0 = (z * z * p * (1 - p)) / (e * e);
                    const n = n0 / (1 + (n0 - 1) / population);
                    
                    return Math.ceil(Math.max(n, 5)); // Minimum 5 samples
                },

                getConfidenceMessage() {
                    const stats = this.validationStats;
                    if (stats.reviewed < 5) {
                        return 'D√©marrez la validation';
                    }
                    if (stats.pValue < 0.05) {
                        if (stats.approvalRate >= 0.8) {
                            return 'Excellente qualit√© confirm√©e !';
                        } else if (stats.approvalRate >= 0.6) {
                            return 'Qualit√© acceptable';
                        } else {
                            return 'Qualit√© insuffisante - r√©vision n√©cessaire';
                        }
                    }
                    return 'Continuez la validation pour plus de certitude';
                },

                getConfidenceDetail() {
                    const stats = this.validationStats;
                    if (stats.reviewed < 5) {
                        return `Validez au moins 5 produits pour obtenir des statistiques. Objectif recommand√©: ${stats.sampleSizeNeeded} produits.`;
                    }
                    if (stats.pValue < 0.05) {
                        return `Avec ${stats.reviewed} produits valid√©s, on peut affirmer avec 95% de confiance que le taux r√©el est entre ${Math.max(0, (stats.approvalRate - stats.marginOfError) * 100).toFixed(0)}% et ${Math.min(100, (stats.approvalRate + stats.marginOfError) * 100).toFixed(0)}%.`;
                    }
                    return `${stats.sampleSizeNeeded - stats.reviewed} produits suppl√©mentaires recommand√©s pour une conclusion statistiquement significative.`;
                },

                generateRationale(proposal) {
                    const rationales = {
                        title: `Titre optimis√© selon le template GMC pour la cat√©gorie. Ajout des attributs cl√©s (marque, type, caract√©ristiques) pour am√©liorer la visibilit√© et le CTR.`,
                        description: `Description enrichie avec les sp√©cifications techniques et b√©n√©fices produit. Structure optimis√©e pour le SEO et la conversion.`,
                        color: `Couleur extraite de l'analyse d'image avec ${(proposal.confidence * 100).toFixed(0)}% de confiance. Correspond au standard GMC pour les filtres de recherche.`,
                        material: `Mat√©riau identifi√© via analyse de l'image produit et/ou recherche web. Am√©liore la pertinence des recherches par mat√©riau.`,
                        gender: `Genre d√©duit du contexte produit (cat√©gorie, titre, image). Permet un meilleur ciblage dans les campagnes Shopping.`,
                        size: `Taille standardis√©e selon les conventions GMC pour la cat√©gorie produit.`,
                        brand: `Marque identifi√©e dans le titre/description existant ou via recherche.`
                    };
                    return rationales[proposal.field.toLowerCase()] || 
                           `Optimisation bas√©e sur l'analyse du produit et les meilleures pratiques GMC. Source: ${proposal.source || 'analyse AI'}.`;
                },

                getFieldIcon(field) {
                    const icons = {
                        title: 'üìù', description: 'üìÑ', color: 'üé®', material: 'üßµ',
                        gender: 'üë§', size: 'üìè', brand: 'üè∑Ô∏è', price: 'üí∞',
                        category: 'üìÅ', image: 'üñºÔ∏è'
                    };
                    return icons[field.toLowerCase()] || 'üìã';
                },

                async applyApprovedProposals() {
                    // Apply all approved proposals from the validation session
                    this.addPipelineLog('info', 'Applying approved proposals', 'Updating product data...');
                    
                    try {
                        const res = await fetch('/api/proposals/bulk', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                action: 'accept',
                                only_status: 'proposed'
                            })
                        });
                        
                        const data = await res.json();
                        this.addPipelineLog('approved', 'Proposals applied', `${data.updated} proposals accepted`);
                        await this.loadProposalsWithProducts();
                    } catch (e) {
                        this.addPipelineLog('rejected', 'Application failed', e.message);
                    }
                },

                // Data loading
                async loadDatasets() {
                    const res = await fetch('/api/datasets');
                    const data = await res.json();
                    this.datasets = data.data || [];
                    // Load stats for each dataset
                    for (const ds of this.datasets) {
                        this.loadDatasetStats(ds.id);
                    }
                },

                async loadProposals() {
                    const res = await fetch('/api/proposals');
                    const data = await res.json();
                    const oldCount = this.proposals.length;
                    this.proposals = data.data || [];
                    
                    if (this.proposals.length > oldCount && oldCount > 0) {
                        this.agentStats.proposalsGenerated = this.proposals.length;
                    }
                    
                    if (this.selectedProduct) {
                        this.productProposals = this.proposals.filter(p => p.product_id === this.selectedProduct.id);
                    }
                },

                async loadProposalsWithProducts() {
                    try {
                        const res = await fetch('/api/proposals/with-products');
                        const data = await res.json();
                        const oldCount = this.proposalsWithProducts.length;
                        this.proposalsWithProducts = data.data || [];
                        this.proposals = this.proposalsWithProducts; // Keep backward compat
                        
                        if (this.proposalsWithProducts.length > oldCount && oldCount > 0) {
                            this.agentStats.proposalsGenerated = this.proposalsWithProducts.length;
                        }
                        
                        if (this.selectedProduct) {
                            this.productProposals = this.proposalsWithProducts.filter(p => p.product_id === this.selectedProduct.id);
                        }
                    } catch (e) {
                        console.error('Failed to load proposals:', e);
                        await this.loadProposals(); // Fallback
                    }
                },

                async bulkAccept() {
                    const pending = this.filteredProposals.filter(p => p.status === 'proposed');
                    if (pending.length === 0) return;
                    
                    const fields = this.proposalFilters.field ? [this.proposalFilters.field] : [];
                    const riskLevels = this.proposalFilters.riskLevel ? [this.proposalFilters.riskLevel] : [];
                    
                    this.addLog('info', 'Bulk accepting proposals', `${pending.length} proposals matching filters`);
                    
                    try {
                        const res = await fetch('/api/proposals/bulk', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                action: 'accept',
                                fields: fields,
                                min_confidence: parseFloat(this.proposalFilters.minConfidence) || 0,
                                risk_levels: riskLevels,
                                only_status: 'proposed'
                            })
                        });
                        
                        const data = await res.json();
                        this.addLog('success', 'Bulk accept complete', `${data.updated} proposals accepted`);
                        await this.loadProposalsWithProducts();
                    } catch (e) {
                        this.addLog('error', 'Bulk accept failed', e.message);
                    }
                },

                async bulkReject() {
                    const pending = this.filteredProposals.filter(p => p.status === 'proposed');
                    if (pending.length === 0) return;
                    
                    const fields = this.proposalFilters.field ? [this.proposalFilters.field] : [];
                    const riskLevels = this.proposalFilters.riskLevel ? [this.proposalFilters.riskLevel] : [];
                    
                    this.addLog('info', 'Bulk rejecting proposals', `${pending.length} proposals matching filters`);
                    
                    try {
                        const res = await fetch('/api/proposals/bulk', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                action: 'reject',
                                fields: fields,
                                min_confidence: parseFloat(this.proposalFilters.minConfidence) || 0,
                                risk_levels: riskLevels,
                                only_status: 'proposed'
                            })
                        });
                        
                        const data = await res.json();
                        this.addLog('success', 'Bulk reject complete', `${data.updated} proposals rejected`);
                        await this.loadProposalsWithProducts();
                    } catch (e) {
                        this.addLog('error', 'Bulk reject failed', e.message);
                    }
                },

                async uploadDataset() {
                    this.uploading = true;
                    this.addLog('info', 'Uploading dataset', `File: ${this.uploadFile.name}`);
                    
                    const formData = new FormData();
                    formData.append('file', this.uploadFile);
                    formData.append('name', this.uploadName || 'Untitled');

                    try {
                        const res = await fetch('/api/datasets/upload', { method: 'POST', body: formData });
                        if (res.ok) {
                            const ds = await res.json();
                            this.addLog('success', 'Dataset uploaded', `${ds.row_count} products imported`);
                            this.uploadFile = null;
                            this.uploadName = '';
                            await this.loadDatasets();
                        }
                    } finally {
                        this.uploading = false;
                    }
                },

                async viewDataset(id) {
                    this.selectedDataset = id;
                    const res = await fetch(`/api/datasets/${id}/products`);
                    const data = await res.json();
                    this.products = data.data || [];
                    this.addLog('info', 'Dataset loaded', `${this.products.length} products`);
                },

                async viewProduct(product) {
                    this.selectedProduct = product;
                    this.productProposals = this.proposals.filter(p => p.product_id === product.id);
                },

                // Enrichment with 6-Agent Pipeline
                async enrichProduct(product) {
                    this.currentEnrichingProduct = product.id;
                    this.isAgentThinking = true;
                    this.pipelineStage = 0;
                    this.currentOperation = `Processing ${product.external_id}...`;
                    
                    // Stage 1: Validate (deterministic)
                    this.pipelineStage = 1;
                    this.currentStageLabel = 'Stage 1: Validating rules...';
                    this.addPipelineLog('validate', 'Hard Rule Validator', 'Checking GMC compliance rules', {
                        agent: 'Deterministic'
                    });
                    
                    try {
                        const res = await fetch(`/api/products/${product.id}/enrich`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ goal: 'GMC compliance + agent readiness' })
                        });

                        if (res.ok) {
                            // Stage 2: Audit
                            setTimeout(() => {
                                this.pipelineStage = 2;
                                this.currentStageLabel = 'Stage 2: Auditing product...';
                                this.addPipelineLog('audit', 'Product Auditor', 'JUDGE only - evaluating quality', {
                                    agent: 'Auditor',
                                    message: 'No rewriting, no suggestions - structured diagnostics only'
                                });
                            }, 500);
                            
                            // Stage 3: Evidence
                            setTimeout(() => {
                                this.pipelineStage = 3;
                                this.currentStageLabel = 'Stage 3: Extracting evidence...';
                                this.addPipelineLog('evidence', 'Image Evidence Agent', 'Extracting visual facts from product image', {
                                    agent: 'Evidence',
                                    message: 'Detect, confirm, deny only - no inference allowed'
                                });
                            }, 1500);
                            
                            // Stage 4: Retrieval
                            setTimeout(() => {
                                this.pipelineStage = 4;
                                this.currentStageLabel = 'Stage 4: Retrieving facts...';
                                this.addPipelineLog('retrieval', 'Knowledge Retrieval', 'Fetching verifiable facts from sources', {
                                    agent: 'Retrieval',
                                    message: 'Every fact must have: source URL + evidence snippet'
                                });
                            }, 2500);
                            
                            // Stage 5: Plan
                            setTimeout(() => {
                                this.pipelineStage = 5;
                                this.currentStageLabel = 'Stage 5: Planning optimizations...';
                                this.addPipelineLog('plan', 'Optimization Planner', 'Deciding WHAT to optimize (not HOW)', {
                                    agent: 'Planner',
                                    message: 'Decision logic only - no text generation'
                                });
                            }, 3500);
                            
                            // Stage 6: Write + Control
                            setTimeout(() => {
                                this.pipelineStage = 6;
                                this.currentStageLabel = 'Stage 6: Executing & validating...';
                                this.addPipelineLog('write', 'Copy Execution', 'Writing under strict constraints', {
                                    agent: 'Writer',
                                    message: 'Using only allowed_facts, respecting forbidden_facts'
                                });
                            }, 4500);

                            setTimeout(() => {
                                this.addPipelineLog('control', 'Controller Agent', 'Validating changes - ready to REJECT', {
                                    agent: 'Controller',
                                    message: 'Checking: facts verified? constraints met? no invention?'
                                });
                            }, 5500);

                            // Poll for completion
                            this.pollEnrichment(product.id);
                        }
                    } catch (e) {
                        this.addPipelineLog('rejected', 'Pipeline Error', e.message, { rejection: e.message });
                        this.currentEnrichingProduct = null;
                        this.isAgentThinking = false;
                        this.currentOperation = null;
                        this.pipelineStage = 0;
                    }
                },

                async pollEnrichment(productId) {
                    let attempts = 0;
                    const poll = async () => {
                        attempts++;
                        await this.loadProposals();
                        await this.refreshProducts();
                        
                        const hasProposals = this.proposals.some(p => p.product_id === productId);
                        const product = this.products.find(p => p.id === productId);
                        
                        if ((product?.status === 'enriched') || attempts >= 30) {
                            this.currentEnrichingProduct = null;
                            this.isAgentThinking = false;
                            this.currentOperation = null;
                            this.currentStageLabel = '';
                            this.pipelineStage = 0;
                            this.agentStats.productsProcessed++;
                            
                            const productProposals = this.proposals.filter(p => p.product_id === productId);
                            const proposalCount = productProposals.length;
                            this.agentStats.proposalsGenerated = this.proposals.filter(p => p.status === 'proposed' || p.status === 'accepted').length;
                            
                            // Log approved proposals
                            for (const prop of productProposals) {
                                this.addPipelineLog('approved', `Field: ${prop.field}`, 
                                    `Changed from "${(prop.before_value || '').substring(0, 30)}..." to "${prop.after_value.substring(0, 30)}..."`, {
                                    agent: 'Controller',
                                    confidence: prop.confidence,
                                    facts: [prop.field]
                                });
                            }
                            
                            if (product?.agent_readiness_score) {
                                this.addPipelineLog('info', 'Pipeline Complete', 
                                    `Score: ${(product.agent_readiness_score * 100).toFixed(0)}% | ${proposalCount} proposals approved`, {
                                    confidence: product.agent_readiness_score
                                });
                            } else {
                                this.addPipelineLog('info', 'Pipeline Complete', `${proposalCount} proposals generated`);
                            }
                            
                            if (this.selectedProduct?.id === productId) {
                                this.productProposals = productProposals;
                            }
                        } else {
                            setTimeout(poll, 2000);
                        }
                    };
                    setTimeout(poll, 3000);
                },

                async refreshProducts() {
                    if (this.selectedDataset) {
                        const res = await fetch(`/api/datasets/${this.selectedDataset}/products`);
                        const data = await res.json();
                        this.products = data.data || [];
                    }
                },

                async enrichAllProducts(datasetId) {
                    if (!datasetId) return;
                    
                    this.globalEnriching = true;
                    this.enrichProgress = 0;
                    const startProposals = this.proposals.length;
                    
                    this.addLog('info', 'üöÄ Global enrichment started', `Processing all products in dataset`);
                    
                    // Load products if not loaded
                    if (!this.products.length || this.selectedDataset !== datasetId) {
                        await this.viewDataset(datasetId);
                    }
                    
                    const pendingProducts = this.products.filter(p => p.status !== 'enriched');
                    const total = pendingProducts.length;
                    
                    this.addLog('info', 'Products to process', `${total} products pending enrichment`);
                    
                    // Process ALL products (no limit)
                    for (let i = 0; i < total; i++) {
                        const product = pendingProducts[i];
                        this.currentEnrichingProduct = product.id;
                        this.currentOperation = `Processing ${i + 1}/${total}: ${product.external_id}`;
                        this.enrichProgress = ((i + 1) / total) * 100;
                        
                        this.addLog('step', `Product ${i + 1}/${total}`, product.external_id);
                        
                        await fetch(`/api/products/${product.id}/enrich`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ goal: 'GMC compliance + agent readiness' })
                        });
                        
                        this.agentStats.productsProcessed++;
                        this.agentStats.toolsUsed += 4;
                        
                        // Refresh proposals and stats periodically to show progress
                        if (i % 5 === 4) {
                            await this.loadProposals();
                            await this.loadDatasetStats(datasetId);
                            const newProposals = this.proposals.length - startProposals;
                            const stats = this.datasetStats[datasetId];
                            const scoreAfter = stats?.scores?.after || 0;
                            this.addLog('info', 'üìä Progress update', 
                                `${newProposals} new proposals | Quality: ${(scoreAfter * 100).toFixed(0)}%`);
                        }
                        
                        // Wait between products to avoid overwhelming the API
                        await new Promise(r => setTimeout(r, 2000));
                    }
                    
                    // Wait for last batch to complete
                    await new Promise(r => setTimeout(r, 5000));
                    await this.loadProposals();
                    await this.refreshProducts();
                    
                    const totalNewProposals = this.proposals.length - startProposals;
                    
                    this.globalEnriching = false;
                    this.currentEnrichingProduct = null;
                    this.currentOperation = null;
                    this.agentStats.proposalsGenerated = this.proposals.length;
                    
                    this.addLog('success', '‚úÖ Global enrichment complete', 
                        `Processed ${total} products, generated ${totalNewProposals} new proposals (${this.proposals.length} total)`);
                },

                async updateProposal(id, action) {
                    const res = await fetch(`/api/proposals/${id}`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action })
                    });
                    if (res.ok) {
                        this.addLog(action === 'accept' ? 'success' : 'info', 
                            `Proposal ${action}ed`, '');
                        await this.loadProposals();
                    }
                },

                async acceptAllProposals() {
                    const pending = this.productProposals.filter(p => p.status === 'proposed');
                    for (const prop of pending) {
                        await this.updateProposal(prop.id, 'accept');
                    }
                },

                async deleteDataset(id) {
                    if (!confirm('Delete this dataset?')) return;
                    await fetch(`/api/datasets/${id}`, { method: 'DELETE' });
                    this.addLog('info', 'Dataset deleted', '');
                    await this.loadDatasets();
                },

                // Helpers
                getProductTitle(p) {
                    if (!p) return '-';
                    const data = this.parseData(p.raw_data);
                    return data.title || data.Title || data.titre || data.Titre || data.name || '-';
                },

                getProductImage(p) {
                    if (!p) return '';
                    const data = this.parseData(p.raw_data);
                    // Try many possible field names for image (GMC uses "image_link" or "image link")
                    return data.image_link || data['image link'] || data.imageLink || 
                           data.image || data.Image || data.image_url || 
                           data.ImageLink || data['Image Link'] || data.IMAGE_LINK ||
                           data.lien_image || data['lien image'] || '';
                },

                parseData(data) {
                    if (!data) return {};
                    if (typeof data === 'string') {
                        try { return JSON.parse(data); } catch { return {}; }
                    }
                    return data;
                },

                getProductAttributes(data) {
                    const parsed = this.parseData(data);
                    const priority = ['titre', 'title', 'description', 'marque', 'brand', 'prix', 'price', 'couleur', 'color'];
                    return Object.entries(parsed).sort((a, b) => {
                        const aIdx = priority.indexOf(a[0].toLowerCase());
                        const bIdx = priority.indexOf(b[0].toLowerCase());
                        if (aIdx !== -1 && bIdx !== -1) return aIdx - bIdx;
                        if (aIdx !== -1) return -1;
                        if (bIdx !== -1) return 1;
                        return a[0].localeCompare(b[0]);
                    });
                },

                getOptimizedAttributes() {
                    const raw = this.parseData(this.selectedProduct?.raw_data);
                    const optimized = { ...raw };
                    for (const prop of this.productProposals) {
                        if (prop.status === 'accepted') {
                            optimized[prop.field] = prop.after_value;
                        }
                    }
                    return this.getProductAttributes(optimized);
                },

                hasProposalForField(field) {
                    return this.productProposals.some(p => 
                        p.field.toLowerCase() === field.toLowerCase() && p.status === 'accepted'
                    );
                },

                parseSources(sources) {
                    if (!sources) return [];
                    if (Array.isArray(sources)) return sources;
                    try { return JSON.parse(sources); } catch { return []; }
                },

                // ============ PROMPTS MANAGEMENT ============
                
                async loadPrompts() {
                    try {
                        const res = await fetch('/api/prompts');
                        const data = await res.json();
                        this.prompts = data.data || [];
                        // Initialize edits with current content
                        for (const p of this.prompts) {
                            this.promptEdits[p.id] = p.content;
                        }
                    } catch (err) {
                        console.error('Failed to load prompts:', err);
                    }
                },

                togglePrompt(promptId) {
                    if (this.expandedPrompts.includes(promptId)) {
                        this.expandedPrompts = this.expandedPrompts.filter(id => id !== promptId);
                    } else {
                        this.expandedPrompts.push(promptId);
                    }
                },

                markPromptDirty(promptId) {
                    const original = this.prompts.find(p => p.id === promptId);
                    if (original && this.promptEdits[promptId] !== original.content) {
                        if (!this.dirtyPrompts.includes(promptId)) {
                            this.dirtyPrompts.push(promptId);
                        }
                    } else {
                        this.dirtyPrompts = this.dirtyPrompts.filter(id => id !== promptId);
                    }
                },

                resetPromptEdit(prompt) {
                    this.promptEdits[prompt.id] = prompt.content;
                    this.dirtyPrompts = this.dirtyPrompts.filter(id => id !== prompt.id);
                },

                async savePrompt(promptId) {
                    this.savingPrompt = promptId;
                    try {
                        const res = await fetch(`/api/prompts/${promptId}`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ content: this.promptEdits[promptId] })
                        });
                        if (res.ok) {
                            const updated = await res.json();
                            // Update local state
                            const idx = this.prompts.findIndex(p => p.id === promptId);
                            if (idx !== -1) {
                                this.prompts[idx] = updated;
                            }
                            this.dirtyPrompts = this.dirtyPrompts.filter(id => id !== promptId);
                            this.addLog('info', `Prompt "${updated.name}" saved successfully`);
                        } else {
                            this.addLog('error', 'Failed to save prompt');
                        }
                    } catch (err) {
                        console.error('Failed to save prompt:', err);
                        this.addLog('error', 'Failed to save prompt');
                    }
                    this.savingPrompt = null;
                },

                getPromptIcon(promptId) {
                    const icons = {
                        'system_prompt': 'ü§ñ',
                        'analyze_product': 'üîç',
                        'analyze_image': 'üëÅÔ∏è',
                        'optimize_title': 'üìù',
                        'optimize_description': 'üìÑ'
                    };
                    return icons[promptId] || 'üìã';
                }
            }
        }
    </script>
</body>
</html>
